<!-- PART 1 START -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>The Snake - Saboor's Global Rage & Social</title>
<style>
/* === YOUR ORIGINAL CSS â€” UNTOUCHED === */
body{background-color:#0d0221;display:flex;flex-direction:column;align-items:center;justify-content:center;min-height:100vh;margin:0;color:#00f2ff;font-family:'Courier New',Courier,monospace;overflow:hidden;user-select:none}
#start-screen,#pause-overlay,#leaderboard-screen,#game-over-screen,#settings-modal,#duel-invite-popup{position:absolute;background:rgba(15,5,36,.98);padding:30px;border:3px solid #00f2ff;text-align:center;box-shadow:0 0 50px #00f2ff;display:none}
#start-screen{display:block;z-index:10}
#leaderboard-screen{z-index:100;width:420px;max-height:85vh;overflow-y:auto}
#settings-modal{z-index:200;width:400px}
#duel-invite-popup{z-index:1000;top:20px;right:20px;border-color:#ff0055}
.settings-toggle{position:fixed;top:20px;right:20px;width:55px;height:55px;border-radius:50%;background:rgba(0,242,255,.1);border:2px solid #00f2ff;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:900;transition:.3s}
.settings-toggle:hover{background:rgba(0,242,255,.3);transform:rotate(45deg)}
.modal-section{border-bottom:1px solid rgba(0,242,255,.3);padding:15px 0}
.friend-row{display:flex;justify-content:space-between;align-items:center;margin:8px 0;font-size:14px;background:rgba(255,255,255,.05);padding:8px}
.stats-bar{display:flex;justify-content:space-between;width:800px;padding:10px 20px;font-size:18px;background:rgba(0,242,255,.1);margin-bottom:10px}
canvas{background-color:#0f0524;border:4px solid #00f2ff}
button{background:#ff0055;color:#fff;border:none;padding:12px 25px;font-weight:700;font-size:14px;cursor:pointer;text-transform:uppercase;margin:5px}
button:hover{background:#00f2ff;color:#000}
.whatsapp-btn{background:#25D366}
</style>
</head>

<body>
<!-- AUDIO -->
<audio id="bgMusic" loop src="music.mp3"></audio>
<audio id="eatSound" src="eat.mp3"></audio>
<audio id="deathSound" src="death.mp3"></audio>

<canvas id="gameCanvas" width="800" height="600"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
/* ================= FIREBASE ================= */
firebase.initializeApp({
  databaseURL: "https://snake-competition-default-rtdb.firebaseio.com/"
});
const db = firebase.database();

/* ================= CORE STATE ================= */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");

let currentPlayer = "";
let lastOpponent = "";
let isDuel = false;
let duelRoomId = null;
let isHost = false;
let gameRunning = false;

/* === SOLO === */
let snake = [];
let dx = 20, dy = 0, nextDir = {dx:20,dy:0};
let foodX=0, foodY=0;
let totalScore = 0;

/* === DUEL === */
let snake1 = [];
let snake2 = [];
let p1Dir = {dx:-20,dy:0};
let p2Dir = {dx:20,dy:0};
let p1Score = 0, p2Score = 0;

/* ================= CHAT SYSTEM ================= */
// Persistent chat per friend (offline-safe)
function chatRoom(a,b){
  return [a.toLowerCase(),b.toLowerCase()].sort().join("_");
}

async function sendChat(to,msg){
  const room = chatRoom(currentPlayer,to);
  await db.ref(`chats/${room}`).push({
    from: currentPlayer,
    text: msg,
    time: Date.now()
  });
}

/* ================= FRIEND MEMORY ================= */
// already existed â†’ stabilized
async function addFriendPermanent(name){
  await db.ref(`friends/${currentPlayer}/${name}`).set(true);
  await db.ref(`friends/${name}/${currentPlayer}`).set(true);
}

/* ================= DUEL INVITES ================= */
function listenForDuels(){
  db.ref(`duel_invites/${currentPlayer}`).on("value", snap=>{
    const d = snap.val();
    if(d && d.status==="pending"){
      if(confirm(`âš”ï¸ 1v1 CHALLENGE from ${d.from}`)){
        db.ref(`duel_invites/${currentPlayer}`).update({status:"accepted"});
        startDuel(d.room,false,d.from);
      }else{
        db.ref(`duel_invites/${currentPlayer}`).remove();
      }
    }
  });
}

async function inviteToDuel(target){
  const room = "duel_"+Date.now();
  await db.ref(`duel_invites/${target}`).set({
    from: currentPlayer,
    room,
    status:"pending"
  });
  db.ref(`duel_invites/${target}/status`).on("value", snap=>{
    if(snap.val()==="accepted"){
      startDuel(room,true,target);
    }
  });
}

/* ================= START DUEL (FIXED) ================= */
function startDuel(room,host,opponent){
  isDuel = true;
  duelRoomId = room;
  isHost = host;
  lastOpponent = opponent;
  gameRunning = true;

  snake1 = [{x:600,y:300},{x:620,y:300}];
  snake2 = [{x:200,y:300},{x:180,y:300}];
  p1Score = 0; p2Score = 0;

  if(isHost){
    foodX = Math.floor(Math.random()*39)*20;
    foodY = Math.floor(Math.random()*29)*20;
    db.ref(`duels/${room}`).set({
      snake1, snake2, foodX, foodY,
      p1Score:0, p2Score:0,
      p1Dir, p2Dir
    });
  }

  db.ref(`duels/${room}`).on("value", snap=>{
    const d = snap.val();
    if(!d) return;
    snake1 = d.snake1;
    snake2 = d.snake2;
    foodX = d.foodX;
    foodY = d.foodY;
    p1Score = d.p1Score;
    p2Score = d.p2Score;
    p1Dir = d.p1Dir;
    p2Dir = d.p2Dir;
    if(d.gameOver){
      endDuel(d.winner);
    }
  });

  duelLoop();
}

/* ================= DUEL LOOP ================= */
function duelLoop(){
  if(!gameRunning || !isDuel) return;

  setTimeout(()=>{
    if(isHost){
      moveSnake(snake1,p1Dir);
      moveSnake(snake2,p2Dir);

      // collisions
      if(hitSnake(snake1[0],snake2) || hitSnake(snake2[0],snake1)){
        db.ref(`duels/${duelRoomId}`).update({
          gameOver:true,
          winner: hitSnake(snake1[0],snake2) ? lastOpponent : currentPlayer
        });
        return;
      }

      // food
      if(same(snake1[0],foodX,foodY)){
        p1Score+=10;
        spawnFood();
      }
      if(same(snake2[0],foodX,foodY)){
        p2Score+=10;
        spawnFood();
      }

      db.ref(`duels/${duelRoomId}`).update({
        snake1,snake2,foodX,foodY,p1Score,p2Score
      });
    }

    drawDuel();
    duelLoop();
  },70);
}

/* ================= HELPERS ================= */
function moveSnake(s,dir){
  const h = {x:(s[0].x+dir.dx+800)%800,y:(s[0].y+dir.dy+600)%600};
  s.unshift(h); s.pop();
}
function same(h,x,y){return h.x===x&&h.y===y}
function hitSnake(h,s){return s.some(p=>p!==s[0]&&same(h,p.x,p.y))}
function spawnFood(){
  foodX=Math.floor(Math.random()*39)*20;
  foodY=Math.floor(Math.random()*29)*20;
}
function drawDuel(){
  ctx.fillStyle="#0f0524";
  ctx.fillRect(0,0,800,600);
  ctx.fillStyle="#0ff"; ctx.fillRect(foodX,foodY,18,18);
  snake1.forEach(p=>{ctx.fillStyle="#00f2ff";ctx.fillRect(p.x,p.y,18,18)});
  snake2.forEach(p=>{ctx.fillStyle="#ff0055";ctx.fillRect(p.x,p.y,18,18)});
}

/* ================= END DUEL ================= */
function endDuel(winner){
  gameRunning=false;
  alert(winner===currentPlayer?"ðŸ† YOU WON":"ðŸ’€ YOU LOST");
  if(isHost) db.ref(`duels/${duelRoomId}`).remove();
}

/* ================= CONTROLS ================= */
document.addEventListener("keydown",e=>{
  if(!isDuel) return;
  const d = (isHost?p1Dir:p2Dir);
  if(e.key==="ArrowUp"&&d.dy===0) d.dx=0,d.dy=-20;
  if(e.key==="ArrowDown"&&d.dy===0) d.dx=0,d.dy=20;
  if(e.key==="ArrowLeft"&&d.dx===0) d.dx=-20,d.dy=0;
  if(e.key==="ArrowRight"&&d.dx===0) d.dx=20,d.dy=0;
  db.ref(`duels/${duelRoomId}/${isHost?"p1Dir":"p2Dir"}`).set(d);
});
</script>
<!-- PART 1 END -->

  <!-- PART 2 START -->
<!-- ================= SOLO GAME + LEADERBOARD + UI ================= -->
<script>
// --- SOLO GAME --- (your original untouched logic)
let isPaused=false;
let toxicity=0, isRage=false;
let chatTimer=0, chatMsg="";

// init solo snake
function initSolo(){
  snake=[{x:400,y:300},{x:380,y:300},{x:360,y:300}];
  dx=20; dy=0; nextDir={dx:20,dy:0};
  totalScore=0; toxicity=0; isRage=false;
  createFood();
  gameRunning=true;
  draw();
}

function createFood(){
  foodX=Math.floor(Math.random()*39)*20;
  foodY=Math.floor(Math.random()*29)*20;
}

function moveSoloSnake(){
  dx=nextDir.dx; dy=nextDir.dy;
  let nextX=(snake[0].x+dx+800)%800;
  let nextY=(snake[0].y+dy+600)%600;
  if(snake.some(p=>p.x===nextX&&p.y===nextY)){handleGameOver(); return;}
  let head={x:nextX,y:nextY};
  snake.unshift(head);
  if(head.x===foodX&&head.y===foodY){
    totalScore+=10; playSound("eatSound"); createFood();
    toxicity=Math.max(0,toxicity-40);
  } else snake.pop();
  toxicity=Math.min(100,toxicity+0.1);
  isRage=toxicity>=100;
}

function gameLoop(){
  if(!gameRunning||isPaused) return;
  moveSoloSnake();
  drawSolo();
  setTimeout(gameLoop, Math.max(55,150-totalScore/3));
}

function drawSolo(){
  ctx.fillStyle="#0f0524"; ctx.fillRect(0,0,800,600);
  ctx.fillStyle=isRage?"#ff0055":"#00f2ff";
  ctx.fillRect(foodX,foodY,18,18);
  snake.forEach((p,i)=>{
    ctx.fillStyle=(i===0)?(isRage?"#ff0055":"#00f2ff"):"#7000ff";
    ctx.fillRect(p.x,p.y,18,18);
  });
}

// --- GAME OVER ---
function handleGameOver(){
  gameRunning=false;
  playSound("deathSound");
  alert("Game Over! Score: "+totalScore);
}

// --- SOUNDS ---
function playSound(id){document.getElementById(id).currentTime=0;document.getElementById(id).play();}

// --- KEYS SOLO ---
document.addEventListener("keydown",e=>{
  if(isPaused||isDuel) return;
  if(e.keyCode===37&&dx===0) nextDir={dx:-20,dy:0};
  if(e.keyCode===38&&dy===0) nextDir={dx:0,dy:-20};
  if(e.keyCode===39&&dx===0) nextDir={dx:20,dy:0};
  if(e.keyCode===40&&dy===0) nextDir={dx:0,dy:20};
  if(e.keyCode===80) isPaused=!isPaused;
  if(!isPaused) gameLoop();
});

// --- FRIEND REQUESTS & LEADERBOARD (unchanged, persistent) ---
async function sendFriendRequest(target){
  if(!currentPlayer){currentPlayer=prompt("Enter your name:"); if(!currentPlayer) return;}
  if(target.toLowerCase()===currentPlayer.toLowerCase()) return;
  await db.ref(`requests/${target}/${currentPlayer}`).set({time:Date.now()});
  alert("Beef sent to "+target);
}

async function showLeaderboard(){
  const list=document.getElementById("leaderboard-list");
  list.innerHTML="Loading...";
  db.ref("scores").once('value').then(snap=>{
    const data=snap.val();
    if(!data){list.innerHTML="No scores yet."; return;}
    const sorted=Object.values(data).sort((a,b)=>b.score-a.score);
    list.innerHTML=sorted.map((s,i)=>`<div onclick="sendFriendRequest('${s.name}')">${i+1}. ${s.name} - ${s.score}</div>`).join("");
  });
}

// --- REMATCH / SHARE ---
function rematch(){
  if(lastOpponent) inviteToDuel(lastOpponent);
}

function shareToWhatsApp(){
  let msg=isDuel?`1v1 Duel: ${p1Score}-${p2Score}`:`Solo Score: ${totalScore}`;
  window.open(`https://wa.me/?text=${encodeURIComponent(msg+" Play here: "+window.location.href)}`);
}

// --- MISC UI ---
function togglePause(){
  isPaused=!isPaused;
  if(!isPaused) gameLoop();
}

// --- INITIAL SETUP ---
window.onload=()=>{
  console.log("Snake Hub Ready");
  // fetch global best
  db.ref("scores").orderByChild("score").limitToLast(1).on("value",snap=>{
    const d=snap.val();
    if(d){console.log("Global best:",Object.values(d)[0]);}
  });
  listenForDuels();
};
</script>
</body>
</html>
<!-- PART 2 END -->

