<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Snake - Saboor's Global Rage & Social</title>
    <style>
        :root { --neon-cyan: #00f2ff; --neon-pink: #ff0055; --bg-dark: #0d0221; }
        body {
            background-color: var(--bg-dark); color: var(--neon-cyan);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; font-family: 'Courier New', Courier, monospace;
            overflow: hidden; user-select: none;
        }

        /* SCREENS */
        #start-screen, #pause-overlay, #leaderboard-screen, #game-over-screen, #settings-modal, #chat-modal {
            position: absolute; background: rgba(15, 5, 36, 0.98);
            padding: 30px; border: 3px solid var(--neon-cyan); text-align: center;
            box-shadow: 0 0 50px var(--neon-cyan); display: none; z-index: 100;
        }
        #start-screen { display: block; }
        #leaderboard-screen { width: 400px; max-height: 80vh; overflow-y: auto; }
        #settings-modal { width: 400px; z-index: 200; }
        #chat-modal { width: 350px; height: 450px; z-index: 300; display: none; flex-direction: column; }
        
        /* 1v1 INVITE POPUP */
        #duel-invite-popup {
            position: fixed; top: 20px; right: 20px; background: #1a1a3a;
            border: 2px solid var(--neon-pink); padding: 15px; z-index: 1000;
            display: none; box-shadow: 0 0 20px var(--neon-pink);
        }

        /* HUB STYLING */
        .settings-toggle {
            position: fixed; top: 20px; right: 80px; width: 50px; height: 50px;
            border-radius: 50%; background: rgba(0, 242, 255, 0.1); border: 2px solid var(--neon-cyan);
            display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 900;
        }
        .friend-row { 
            display: flex; justify-content: space-between; align-items: center; 
            margin: 5px 0; padding: 8px; background: rgba(255,255,255,0.05); border-left: 3px solid var(--neon-cyan);
        }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; display: inline-block; margin-right: 8px; }
        .online { background: #00ff00; box-shadow: 0 0 8px #00ff00; }
        .offline { background: #555; }

        /* CHAT */
        #chat-display { flex-grow: 1; overflow-y: auto; text-align: left; padding: 10px; border: 1px solid var(--neon-cyan); margin-bottom: 10px; background: #000; font-size: 13px; }
        .msg-line { margin-bottom: 4px; }
        .msg-name { color: var(--neon-pink); font-weight: bold; }

        /* ORIGINAL GAME UI */
        canvas { background-color: #0f0524; border: 4px solid var(--neon-cyan); }
        .stats-bar { display: flex; justify-content: space-between; width: 800px; padding: 10px 20px; font-size: 18px; background: rgba(0, 242, 255, 0.1); margin-bottom: 10px; }
        .toxic-wrapper { position: absolute; right: -35px; display: none; flex-direction: column; align-items: center; }
        .toxic-container-vertical { width: 10px; height: 300px; background: #1a1a3a; border: 2px solid var(--neon-cyan); border-radius: 10px; overflow: hidden; }
        #toxic-bar { width: 100%; height: 0%; background: linear-gradient(0deg, var(--neon-cyan), var(--neon-pink)); transition: height 0.3s ease; }
        
        button { background: var(--neon-pink); color: white; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin: 3px; font-family: 'Courier New'; }
        button:hover { background: var(--neon-cyan); color: #000; }
        input { background: #16213e; border: 2px solid var(--neon-cyan); color: white; padding: 10px; text-align: center; outline: none; }
        .whatsapp-btn { background: #25D366; }
        .lb-item { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; cursor: pointer; }
        .lb-item:hover { background: rgba(0, 242, 255, 0.1); }
    </style>
</head>
<body>

    <audio id="bgMusic" loop src="music.mp3"></audio>
    <audio id="eatSound" src="eat.mp3" preload="auto"></audio>
    <audio id="deathSound" src="death.mp3" preload="auto"></audio>

    <div class="settings-toggle" onclick="toggleSettings()">üë•</div>

    <div id="duel-invite-popup">
        <p id="duel-invite-text" style="margin:0 0 10px 0; font-size:12px; font-weight:bold;"></p>
        <button onclick="respondDuel(true)" style="padding:5px 10px; font-size:12px;">ACCEPT</button>
        <button onclick="respondDuel(false)" style="padding:5px 10px; font-size:12px;">DECLINE</button>
    </div>

    <div id="chat-modal">
        <h3 id="chat-with-name" style="margin:0 0 10px 0;">FRIEND CHAT</h3>
        <div id="chat-display"></div>
        <input type="text" id="chatInput" placeholder="Talk trash..." style="width:90%; margin-bottom:10px;">
        <div style="display:flex; justify-content:center;">
            <button onclick="sendChatMessage()">SEND</button>
            <button onclick="document.getElementById('chat-modal').style.display='none'">CLOSE</button>
        </div>
    </div>

    <div id="settings-modal">
        <h2 style="margin-top:0;">SABOOR'S HUB</h2>
        <div style="border-bottom: 1px solid #333; padding-bottom:10px; margin-bottom:10px;">
            <p style="font-size:12px; color:var(--neon-pink);">FRIEND REQUESTS</p>
            <div id="req-box" style="max-height:100px; overflow-y:auto;"></div>
        </div>
        <div>
            <p style="font-size:12px; color:var(--neon-cyan);">MY FRIENDS</p>
            <div id="friends-list" style="max-height:200px; overflow-y:auto;"></div>
        </div>
        <button onclick="toggleSettings()" style="margin-top:15px;">BACK TO GAME</button>
    </div>

    <div id="start-screen">
        <h1 style="font-size: 50px; margin:0; letter-spacing: 5px;">THE SNAKE</h1>
        <input type="text" id="playerName" placeholder="Enter Nickname" maxlength="12">
        <button onclick="attemptStart()">Quick Start ‚ö°</button>
        <button onclick="showLeaderboard()">Leaderboard üèÜ</button>
        <div style="margin-top:20px; font-size:12px; opacity:0.6;">Created by Saboor üç≠</div>
    </div>

    <div id="leaderboard-screen">
        <h2 style="color:var(--neon-cyan);">HALL OF FAME</h2>
        <p style="font-size:10px;">Click a player to send Friend Request</p>
        <div id="leaderboard-list"></div>
        <button onclick="closeLeaderboard()">CLOSE</button>
    </div>

    <div id="game-over-screen">
        <h1 id="over-title">GAME OVER</h1>
        <p id="over-roast" style="color: var(--neon-pink); font-weight: bold;"></p>
        <h2 id="over-score">SCORE: 0</h2>
        <button onclick="location.reload()">MENU</button>
        <button id="rematchBtn" style="display:none;" onclick="inviteToDuel(lastOpponent)">REMATCH</button>
        <button class="whatsapp-btn" onclick="shareToWhatsApp()">SHARE RESULT üì≤</button>
    </div>

    <div id="pause-overlay"><h1>PAUSED</h1><button onclick="togglePause()">RESUME</button></div>

    <div class="stats-bar">
        <div id="score-display">SCORE: <span id="scoreVal">0</span></div>
        <div style="color: var(--neon-pink);" id="wr-box">WR: <span id="highScoreVal">0</span> BY <span id="highScoreName">NONE</span></div>
    </div>

    <div class="main-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="toxic-wrapper" id="toxic-ui">
            <div style="font-size:10px; font-weight:bold; color:var(--neon-pink); margin-bottom:5px; writing-mode:vertical-rl; transform:rotate(180deg);">TOXICITY</div>
            <div class="toxic-container-vertical"><div id="toxic-bar"></div></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        // --- FIREBASE CONFIG ---
        const firebaseConfig = { databaseURL: "https://snake-competition-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- CONSTANTS ---
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        const startRoasts = ["Identify yourself so I know who to laugh at.", "Name box is empty, just like your future.", "Even a goldfish has a name. What's yours?"];
        const crashRoasts = ["PATHETIC. JUST UNINSTALL.", "THAT WALL HAD A FAMILY!", "SCORE LOWER THAN YOUR IQ.", "I'D CALL YOU TRASH BUT TRASH CAN BE RECYCLED."];
        const duelRoasts = ["Hamster powered WiFi!", "Snail reflexes!", "Imagine losing to me lol.", "U smell like defeat.", "My grandma targets better!"];
        const praise = ["NEW RECORD! Finally the smartest among the idiots.", "HIGH SCORE! Mom is so proud of her basement dweller."];

        // --- STATE ---
        let currentPlayer = "";
        let snake = [], snake2 = [], dx = 20, dy = 0, nextDir = {dx:20, dy:0};
        let foodX, foodY, totalScore = 0, p2Score = 0, toxicity = 0, isRage = false;
        let gameRunning = false, isPaused = false, isDuel = false;
        let duelRoomId = null, isHost = false, lastOpponent = null, chatFriend = null;
        let chatTimer = 0, chatMsg = "";

        // --- INITIALIZATION ---
        window.onload = () => { fetchGlobalHigh(); };

        function updateMyOnlineStatus() {
            if(!currentPlayer) return;
            const ref = db.ref(`users/${currentPlayer.toLowerCase()}`);
            ref.set({ name: currentPlayer, lastSeen: Date.now(), online: true });
            ref.onDisconnect().update({ online: false });
        }

        function attemptStart() {
            const name = document.getElementById("playerName").value.trim();
            if (name.length < 2) { alert(startRoasts[Math.floor(Math.random()*startRoasts.length)]); return; }
            currentPlayer = name;
            updateMyOnlineStatus();
            listenForInvites();
            document.getElementById("start-screen").style.display = "none";
            document.getElementById("toxic-ui").style.display = "flex";
            resetSnake();
            gameRunning = true;
            document.getElementById("bgMusic").volume = 0.15;
            document.getElementById("bgMusic").play();
            gameLoop();
        }

        function resetSnake() {
            snake = [{x: 400, y: 300}, {x: 380, y: 300}, {x: 360, y: 300}];
            dx = 20; dy = 0; nextDir = {dx:20, dy:0};
            totalScore = 0; toxicity = 0; isRage = false;
            createFood();
        }

        // --- SOCIAL SYSTEM ---
        function toggleSettings() {
            const mod = document.getElementById("settings-modal");
            mod.style.display = (mod.style.display === "block") ? "none" : "block";
            if(mod.style.display === "block") refreshSocialHub();
        }

        function refreshSocialHub() {
            if(!currentPlayer) return;
            // Get Friend Requests
            db.ref(`requests/${currentPlayer.toLowerCase()}`).on('value', snap => {
                const data = snap.val();
                const box = document.getElementById("req-box");
                box.innerHTML = data ? Object.keys(data).map(k => `
                    <div class="friend-row"><span>${k.toUpperCase()}</span><button onclick="acceptFriend('${k}')">ACCEPT</button></div>
                `).join('') : "No pending requests.";
            });

            // Get Permanent Friends & Online Status
            db.ref(`friends/${currentPlayer.toLowerCase()}`).on('value', async snap => {
                const friends = snap.val();
                const list = document.getElementById("friends-list");
                if(!friends) { list.innerHTML = "No friends saved."; return; }
                list.innerHTML = "";
                for(let f in friends) {
                    const uSnap = await db.ref(`users/${f}`).get();
                    const status = uSnap.val()?.online ? 'online' : 'offline';
                    list.innerHTML += `
                        <div class="friend-row">
                            <span><span class="status-dot ${status}"></span>${f.toUpperCase()}</span>
                            <div>
                                <button onclick="openChat('${f}')" style="background:#444;">CHAT</button>
                                ${status==='online' ? `<button onclick="inviteToDuel('${f}')">1v1</button>` : ''}
                            </div>
                        </div>`;
                }
            });
        }

        async function acceptFriend(name) {
            await db.ref(`friends/${currentPlayer.toLowerCase()}/${name.toLowerCase()}`).set(true);
            await db.ref(`friends/${name.toLowerCase()}/${currentPlayer.toLowerCase()}`).set(true);
            await db.ref(`requests/${currentPlayer.toLowerCase()}/${name.toLowerCase()}`).remove();
        }

        // --- CHAT SYSTEM ---
        function openChat(friend) {
            chatFriend = friend;
            document.getElementById("chat-with-name").innerText = "TALK TRASH: " + friend.toUpperCase();
            document.getElementById("chat-modal").style.display = "flex";
            const chatKey = [currentPlayer.toLowerCase(), friend.toLowerCase()].sort().join("_");
            db.ref(`chats/${chatKey}`).limitToLast(20).on('value', snap => {
                const msgs = snap.val();
                const display = document.getElementById("chat-display");
                display.innerHTML = msgs ? Object.values(msgs).map(m => `
                    <div class="msg-line"><span class="msg-name">${m.sender}:</span> ${m.text}</div>
                `).join('') : "Leave a message for when they're back!";
                display.scrollTop = display.scrollHeight;
            });
        }

        function sendChatMessage() {
            const txt = document.getElementById("chatInput").value.trim();
            if(!txt || !chatFriend) return;
            const chatKey = [currentPlayer.toLowerCase(), chatFriend.toLowerCase()].sort().join("_");
            db.ref(`chats/${chatKey}`).push({ sender: currentPlayer.toUpperCase(), text: txt, time: Date.now() });
            document.getElementById("chatInput").value = "";
        }

        // --- 1v1 DUEL ENGINE ---
        function listenForInvites() {
            db.ref(`duels_invite/${currentPlayer.toLowerCase()}`).on('value', snap => {
                const d = snap.val();
                if(d && d.status === "pending") {
                    lastOpponent = d.from; duelRoomId = d.room;
                    document.getElementById("duel-invite-text").innerText = d.from.toUpperCase() + " WANTS TO COOK YOU!";
                    document.getElementById("duel-invite-popup").style.display = "block";
                }
            });
        }

        async function inviteToDuel(target) {
            lastOpponent = target;
            const roomId = "room_" + Date.now();
            await db.ref(`duels_invite/${target.toLowerCase()}`).set({ from: currentPlayer, room: roomId, status: "pending" });
            db.ref(`duels_invite/${target.toLowerCase()}/status`).on('value', snap => {
                if(snap.val() === "accepted") startDuel(roomId, true, target);
            });
            alert("Invite Sent! Wait for them to accept...");
        }

        async function respondDuel(acc) {
            document.getElementById("duel-invite-popup").style.display = "none";
            if(acc) {
                await db.ref(`duels_invite/${currentPlayer.toLowerCase()}`).update({status: "accepted"});
                startDuel(duelRoomId, false, lastOpponent);
            } else { await db.ref(`duels_invite/${currentPlayer.toLowerCase()}`).remove(); }
        }

        function startDuel(rid, host, opp) {
            isDuel = true; duelRoomId = rid; isHost = host; lastOpponent = opp;
            gameRunning = true; isPaused = false;
            document.getElementById("settings-modal").style.display = "none";
            document.getElementById("start-screen").style.display = "none";
            document.getElementById("wr-box").style.display = "none";
            
            // Positioning
            snake = isHost ? [{x:600, y:300}, {x:620, y:300}] : [{x:100, y:300}, {x:80, y:300}];
            dx = isHost ? -20 : 20; dy = 0; totalScore = 0; p2Score = 0;

            if(isHost) {
                createFood();
                db.ref(`duel_rooms/${rid}`).set({ 
                    foodX, foodY, p1Score: 0, p2Score: 0, 
                    p1Body: snake, p2Body: [{x:100, y:300}, {x:80, y:300}], 
                    gameOver: false 
                });
            }

            db.ref(`duel_rooms/${rid}`).on('value', snap => {
                const v = snap.val(); if(!v) return;
                foodX = v.foodX; foodY = v.foodY;
                if(isHost) { snake2 = v.p2Body; p2Score = v.p2Score; } 
                else { snake2 = v.p1Body; p2Score = v.p1Score; }
                if(v.gameOver) handleDuelEnd(v.winner);
            });
            gameLoop();
        }

        // --- CORE GAME LOOP ---
        function gameLoop() {
            if (!gameRunning || isPaused) return;
            let speed = isDuel ? 80 : (isRage ? 45 : Math.max(55, 150 - (totalScore/3)));

            setTimeout(() => {
                dx = nextDir.dx; dy = nextDir.dy;
                let head = { x: snake[0].x + dx, y: snake[0].y + dy };

                // Wrap Logic
                if(head.x < 0) head.x = 780; else if(head.x >= 800) head.x = 0;
                if(head.y < 0) head.y = 580; else if(head.y >= 600) head.y = 0;

                // Collision Check
                if (isDuel) {
                    // Check if I hit myself OR the opponent
                    if (snake.some(p => p.x === head.x && p.y === head.y) || snake2.some(p => p.x === head.x && p.y === head.y)) {
                        db.ref(`duel_rooms/${duelRoomId}`).update({ gameOver: true, winner: lastOpponent }); return;
                    }
                    // Random trash talk during duel
                    if(Math.random() < 0.01) { chatMsg = duelRoasts[Math.floor(Math.random()*duelRoasts.length)]; chatTimer = 30; }
                } else {
                    if (snake.some(p => p.x === head.x && p.y === head.y)) { handleGameOver(); return; }
                }

                snake.unshift(head);

                if (head.x === foodX && head.y === foodY) {
                    totalScore += 10; playSound("eatSound");
                    if(!isDuel) { toxicity = Math.max(0, toxicity - 40); createFood(); }
                    else { if(isHost) createFood(); }
                } else { snake.pop(); }

                if(!isDuel) {
                    toxicity = Math.min(100, toxicity + 0.15);
                    isRage = toxicity >= 100;
                } else {
                    const update = isHost ? { p1Body: snake, p1Score: totalScore } : { p2Body: snake, p2Score: totalScore };
                    db.ref(`duel_rooms/${duelRoomId}`).update(update);
                }

                draw();
                gameLoop();
            }, speed);
        }

        function draw() {
            ctx.fillStyle = "#0f0524"; ctx.fillRect(0, 0, 800, 600);
            
            // Food
            ctx.fillStyle = isRage ? var(--neon-pink) : var(--neon-cyan);
            ctx.beginPath(); ctx.arc(foodX+10, foodY+10, 8, 0, Math.PI*2); ctx.fill();

            // My Snake
            snake.forEach((p, i) => {
                ctx.fillStyle = isRage ? "#ff0055" : (i === 0 ? "#00f2ff" : "#7000ff");
                ctx.fillRect(p.x, p.y, 18, 18);
            });

            // Opponent Snake (Duel Only)
            if(isDuel) {
                snake2.forEach((p, i) => {
                    ctx.fillStyle = (i === 0 ? "#ff0055" : "#ff8800");
                    ctx.fillRect(p.x, p.y, 18, 18);
                });
                document.getElementById("score-display").innerHTML = `YOU: ${totalScore} | ${lastOpponent.toUpperCase()}: ${p2Score}`;
            }

            // Duel Roasts
            if (chatTimer > 0) {
                ctx.fillStyle = "white"; ctx.font = "14px Courier New"; ctx.textAlign = "center";
                ctx.fillText(chatMsg, snake[0].x + 10, snake[0].y - 15);
                chatTimer--;
            }

            document.getElementById("scoreVal").innerText = totalScore;
            document.getElementById("toxic-bar").style.height = toxicity + "%";
        }

        // --- END GAME LOGIC ---
        function handleGameOver() {
            gameRunning = false; playSound("deathSound");
            saveScore(currentPlayer, totalScore);
            document.getElementById("over-roast").innerText = crashRoasts[Math.floor(Math.random()*crashRoasts.length)];
            document.getElementById("over-score").innerText = "SCORE: " + totalScore;
            document.getElementById("game-over-screen").style.display = "block";
            document.getElementById("rematchBtn").style.display = "none";
        }

        function handleDuelEnd(winner) {
            gameRunning = false;
            const won = winner.toLowerCase() === currentPlayer.toLowerCase();
            document.getElementById("over-title").innerText = won ? "VICTORY" : "DEFEAT";
            document.getElementById("over-roast").innerText = won ? "Absolute legend behavior." : duelRoasts[Math.floor(Math.random()*duelRoasts.length)];
            document.getElementById("over-score").innerText = `Final Score: ${totalScore}`;
            document.getElementById("rematchBtn").style.display = "inline-block";
            document.getElementById("game-over-screen").style.display = "block";
            if(isHost) db.ref(`duel_rooms/${duelRoomId}`).remove();
        }

        // --- WHATSAPP SHARE ---
        function shareToWhatsApp() {
            const link = window.location.href;
            let text = isDuel ? 
                `üêç SNAKE DUEL! I ${document.getElementById("over-title").innerText} against ${lastOpponent}!\nMy Score: ${totalScore}\nChallenge us: ${link}` :
                `üêç THE SNAKE! Score: ${totalScore}\nSystem said: "${document.getElementById("over-roast").innerText}"\nPlay: ${link}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        // --- UTILS ---
        function createFood() {
            foodX = Math.floor(Math.random() * 39) * 20;
            foodY = Math.floor(Math.random() * 29) * 20;
            if(isDuel && isHost) db.ref(`duel_rooms/${duelRoomId}`).update({foodX, foodY});
        }
        function playSound(id) { const s = document.getElementById(id); s.currentTime = 0; s.play(); }
        function togglePause() { if(!gameRunning || isDuel) return; isPaused = !isPaused; document.getElementById("pause-overlay").style.display = isPaused ? "block" : "none"; if(!isPaused) gameLoop(); }
        async function fetchGlobalHigh() { db.ref("scores").orderByChild("score").limitToLast(1).on('value', snap => { const d = snap.val(); if(d) { const top = Object.values(d)[0]; document.getElementById("highScoreVal").innerText = top.score; document.getElementById("highScoreName").innerText = top.name.toUpperCase(); } }); }
        async function saveScore(n, s) { if(s<=0)return; db.ref(`scores/${n.toLowerCase()}`).set({name:n, score:s}); }
        function showLeaderboard() { document.getElementById("leaderboard-screen").style.display = "block"; db.ref("scores").once('value', snap => { const data = snap.val(); if(data) { const sorted = Object.values(data).sort((a,b)=>b.score-a.score); document.getElementById("leaderboard-list").innerHTML = sorted.map((s,i)=>`<div class="lb-item" onclick="sendFriendRequest('${s.name}')"><span>${i+1}. ${s.name}</span><span>${s.score}</span></div>`).join(''); } }); }
        async function sendFriendRequest(target) { if(target.toLowerCase() === currentPlayer.toLowerCase()) return; await db.ref(`requests/${target.toLowerCase()}/${currentPlayer.toLowerCase()}`).set({time:Date.now()}); alert("Friend request sent to " + target); }
        function closeLeaderboard() { document.getElementById("leaderboard-screen").style.display = "none"; }

        // --- CONTROLS ---
        document.addEventListener("keydown", e => {
            if (document.activeElement.tagName === "INPUT") return;
            const k = e.keyCode;
            if (k === 80) togglePause();
            if (isPaused || !gameRunning) return;
            if ((k === 37 || k === 65) && dx === 0) nextDir = { dx: -20, dy: 0 };
            if ((k === 38 || k === 87) && dy === 0) nextDir = { dx: 0, dy: -20 };
            if ((k === 39 || k === 68) && dx === 0) nextDir = { dx: 20, dy: 0 };
            if ((k === 40 || k === 83) && dy === 0) nextDir = { dx: 0, dy: 20 };
        });
    </script>
</body>
</html>
