<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
     <title>The Snake - Saboor's Global Rage</title>
     <style>
         /* --- UI & LAYOUT --- */
         body {
             background-color: #0d0221;
             display: flex; flex-direction: column; align-items: center; justify-content: flex-start;
             min-height: 100vh; margin: 0; color: #00f2ff;
             font-family: 'Courier New', Courier, monospace;
             overflow: hidden; user-select: none;
             transition: background-color 0.8s ease;
             touch-action: none;
         }
         #start-screen, #pause-overlay, #leaderboard-screen, #game-over-screen {
             position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
             background: rgba(15, 5, 36, 0.98); padding: 30px; border: 3px solid #00f2ff;
             text-align: center; z-index: 100; box-shadow: 0 0 50px #00f2ff;
             width: 85%; max-width: 450px;
         }
         #pause-overlay, #leaderboard-screen, #game-over-screen { display: none; }
         #leaderboard-screen { width: 380px; max-height: 80vh; overflow-y: auto; }

         /* --- GAME CANVAS & RESPONSIVENESS --- */
         .main-container { position: relative; display: flex; flex-direction: column; align-items: center; width: 100%; margin-top: 5px; }
         canvas { 
             background-color: #0f0524; border: 4px solid #00f2ff; 
             box-shadow: 0 0 20px rgba(0, 242, 255, 0.2);
             max-width: 98vw; max-height: 55vh; height: auto; display: block;
         }

         /* --- TOXICITY BAR --- */
         .toxic-wrapper { position: absolute; right: 10px; top: 10px; display: flex; flex-direction: column; align-items: center; z-index: 10; }
         .toxic-container-vertical { width: 12px; height: 150px; background: #1a1a3a; border: 2px solid #00f2ff; border-radius: 10px; position: relative; overflow: hidden; }
         #toxic-bar { width: 100%; height: 0%; background: linear-gradient(0deg, #00f2ff, #ff0055); transition: height 0.3s; position: absolute; bottom: 0; }

         /* --- STATS & AUDIO --- */
         .stats-bar {
             display: flex; justify-content: space-between; width: 95vw; max-width: 800px; padding: 10px; font-size: 14px;
             background: rgba(0, 242, 255, 0.1); border: 2px solid rgba(0, 242, 255, 0.3); margin-top: 5px;
         }
         .audio-settings { position: fixed; top: 15px; left: 15px; display: flex; gap: 10px; z-index: 1000; }
         .circle-btn { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #00f2ff; display: flex; align-items: center; justify-content: center; cursor: pointer; }
         .circle-btn svg { width: 20px; fill: #00f2ff; }
         .circle-btn.muted { border-color: #ff0055; opacity: 0.5; }

         /* --- MOBILE CONTROLS (THE D-PAD) --- */
         #mobile-controls {
             display: none; grid-template-columns: repeat(3, 1fr); gap: 10px;
             width: 240px; margin-top: 15px; padding-bottom: 20px;
         }
         .control-btn {
             width: 75px; height: 75px; background: rgba(0, 242, 255, 0.05);
             border: 2px solid #00f2ff; border-radius: 15px;
             display: flex; align-items: center; justify-content: center;
             color: #00f2ff; font-size: 30px; font-weight: bold;
         }
         .control-btn:active { background: #ff0055; border-color: #ff0055; color: white; transform: scale(0.9); }

         @media (max-width: 768px) { #mobile-controls { display: grid; } }

         /* --- BUTTONS & INPUTS --- */
         button { background: #ff0055; color: white; border: none; padding: 15px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 10px; text-transform: uppercase; }
         input { background: #16213e; border: 2px solid #00f2ff; color: white; padding: 12px; width: 80%; text-align: center; font-size: 18px; margin-bottom: 10px; }
         #map-notifier { position: absolute; top: 30%; left: 50%; transform: translateX(-50%); font-size: 28px; font-weight: bold; color: white; text-shadow: 0 0 15px #00f2ff; opacity: 0; z-index: 200; pointer-events: none; }
     </style>
</head>
<body>
     
     <audio id="bgMusic" loop src="music.mp3"></audio>
     <audio id="eatSound" src="eat.mp3" preload="auto"></audio>
     <audio id="deathSound" src="death.mp3" preload="auto"></audio>
     <audio id="rageSound" loop src="rage.mp3" preload="auto"></audio>
     <audio id="levelUpSound" src="levelup.mp3" preload="auto"></audio>
     <audio id="mapChangeSound" src="mapchange.mp3" preload="auto"></audio>
     
     <div id="map-notifier">NEON CITY</div>

     <div class="audio-settings">
          <div id="musicBtn" class="circle-btn" onclick="toggleMusic()"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>
          <div id="sfxBtn" class="circle-btn" onclick="toggleSFX()"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02z"/></svg></div>
     </div>

     <div id="start-screen">
          <h1 style="letter-spacing: 4px;">THE SNAKE</h1>
          <input type="text" id="playerName" placeholder="Enter Name" maxlength="12">
          <button onclick="attemptStart()">QUICK START ‚ö°</button>
          <button onclick="showLeaderboard()">TOP LEGENDS üèÜ</button>
          <p style="font-size: 10px; opacity: 0.5; margin-top: 15px;">Created by Saboor üç≠</p>
     </div>

     <div id="leaderboard-screen">
          <h2>HALL OF FAME</h2>
          <div id="leaderboard-list">Loading...</div>
          <button onclick="closeLeaderboard()">CLOSE</button>
     </div>

     <div id="game-over-screen">
          <h1 id="over-title">WASTED</h1>
          <p id="over-roast" style="color: #ff0055; font-weight: bold;"></p>
          <h2 id="over-score">SCORE: 0</h2>
          <button onclick="location.reload()">TRY AGAIN</button>
          <button style="background:#25D366" onclick="shareToWhatsApp()">WHATSAPP SCORE üì≤</button>
     </div>

     <div id="pause-overlay"><h1>PAUSED</h1><button onclick="togglePause()">RESUME</button></div>

     <div class="stats-bar">
          <div>LVL: <span id="levelVal" style="color: gold;">1</span></div>
          <div>SCORE: <span id="scoreVal">0</span></div>
          <div style="color: #ff0055;">WR: <span id="highScoreVal">0</span> BY <span id="highScoreName">NONE</span></div>
     </div>

     <div class="main-container">
          <canvas id="gameCanvas" width="800" height="600"></canvas>
          
          <div class="toxic-wrapper" id="toxic-ui" style="display:none;">
               <div class="toxic-container-vertical"><div id="toxic-bar"></div></div>
          </div>

          <div id="mobile-controls">
               <div></div><div class="control-btn" onclick="setDir(0,-20)">‚ñ≤</div><div></div>
               <div class="control-btn" onclick="setDir(-20,0)">‚óÄ</div><div class="control-btn" onclick="setDir(0,20)">‚ñº</div><div class="control-btn" onclick="setDir(20,0)">‚ñ∂</div>
          </div>
     </div>

     <script>
          const DB_URL = "https://snake-competition-default-rtdb.firebaseio.com/";
          const canvas = document.getElementById("gameCanvas");
          const ctx = canvas.getContext("2d");

          // --- ALL ORIGINAL DATA ---
          let musicEnabled = true, sfxEnabled = true;
          let snake = [{x: 400, y: 300}, {x: 380, y: 300}, {x: 360, y: 300}];
          let hurdles = [], dx = 20, dy = 0, totalScore = 0, currentLevel = 1, gameRunning = false, isPaused = false;
          let foodX, foodY, toxicity = 0, isRage = false, chatTimer = 0, chatMsg = "", wasNear = false, missCombo = 0, currentPlayer = "";
          let nextDirection = { dx: 20, dy: 0 }, isRageSoundPlaying = false;

          const themes = [
              { name: "NEON CITY", bg: "#0d0221", snake: "#00f2ff", body: "#7000ff", hurdle: "#333" },
              { name: "EMERALD JUNGLE", bg: "#02210b", snake: "#2ecc71", body: "#27ae60", hurdle: "#3e2723" },
              { name: "BLOOD MOON", bg: "#210202", snake: "#ff4d4d", body: "#800000", hurdle: "#444" },
              { name: "DEEP OCEAN", bg: "#021a21", snake: "#00d4ff", body: "#005b96", hurdle: "#1a237e" },
              { name: "CYBER VOID", bg: "#000000", snake: "#f1c40f", body: "#e67e22", hurdle: "#ffffff" }
          ];
          let currentTheme = themes[0];

          const crashRoasts = ["PATHETIC. JUST UNINSTALL.", "THAT WALL HAD A FAMILY!", "SCORE LOWER THAN YOUR IQ.", "A POTATO HAS BETTER REFLEXES.", "CLOWN BEHAVIOR."];
          const missRoasts = ["EMOTIONAL DAMAGE!", "WHEEZE... MISS?!", "LMAO, TRASH.", "GIT GUD."];

          // --- MOBILE CONTROLS (SWIPE + BUTTONS) ---
          let tStart = {x: 0, y: 0};
          document.addEventListener('touchstart', e => { tStart.x = e.touches[0].screenX; tStart.y = e.touches[0].screenY; }, {passive: false});
          document.addEventListener('touchend', e => { 
               let swX = e.changedTouches[0].screenX - tStart.x;
               let swY = e.changedTouches[0].screenY - tStart.y;
               if (Math.abs(swX) > Math.abs(swY)) {
                    if (swX > 30 && dx === 0) setDir(20, 0);
                    else if (swX < -30 && dx === 0) setDir(-20, 0);
               } else {
                    if (swY > 30 && dy === 0) setDir(0, 20);
                    else if (swY < -30 && dy === 0) setDir(0, -20);
               }
          }, {passive: false});

          function setDir(nx, ny) { if(gameRunning && !isPaused) nextDirection = {dx: nx, dy: ny}; }

          // --- CORE FUNCTIONS ---
          function toggleMusic() { musicEnabled = !musicEnabled; const m = document.getElementById("bgMusic"); musicEnabled ? (document.getElementById("musicBtn").classList.remove("muted"), gameRunning && m.play()) : (document.getElementById("musicBtn").classList.add("muted"), m.pause()); }
          function toggleSFX() { sfxEnabled = !sfxEnabled; document.getElementById("sfxBtn").classList.toggle("muted", !sfxEnabled); }
          function playSfx(id) { if(sfxEnabled) { let s=document.getElementById(id); s.currentTime=0; s.play().catch(()=>{}); }}

          async function fetchGlobalHigh() {
              try {
                  const r = await fetch(DB_URL + "scores.json");
                  const d = await r.json();
                  if (d) {
                      const s = Object.values(d).sort((a,b) => b.score - a.score);
                      document.getElementById("highScoreVal").innerText = s[0].score;
                      document.getElementById("highScoreName").innerText = s[0].name.toUpperCase();
                  }
              } catch(e) {}
          }

          function spawnHurdles(count) {
              for(let i=0; i<count; i++) {
                  let hX, hY;
                  do { hX = Math.floor(Math.random() * 37) * 20; hY = Math.floor(Math.random() * 27) * 20; } 
                  while (snake.some(p => Math.abs(p.x - hX) < 60 && Math.abs(p.y - hY) < 60));
                  hurdles.push({x: hX, y: hY});
              }
          }

          function changeMap() {
              let idx = (Math.floor((currentLevel-1) / 3)) % themes.length;
              currentTheme = themes[idx];
              document.body.style.backgroundColor = currentTheme.bg;
              canvas.style.borderColor = currentTheme.snake;
              hurdles = []; spawnHurdles(3);
              const n = document.getElementById("map-notifier");
              n.innerText = currentTheme.name; n.style.opacity = "1";
              playSfx("mapChangeSound"); setTimeout(() => n.style.opacity = "0", 2500);
          }

          function attemptStart() {
              const n = document.getElementById("playerName").value.trim();
              if (n.length < 2) return;
              currentPlayer = n;
              document.getElementById("start-screen").style.display = "none";
              document.getElementById("toxic-ui").style.display = "flex";
              if (musicEnabled) document.getElementById("bgMusic").play().catch(()=>{});
              gameRunning = true; createFood(); gameLoop();
          }

          function gameLoop() {
              if (!gameRunning || isPaused) return;
              let speed = isRage ? 45 : Math.max(45, 130 - (totalScore/4));
              
              setTimeout(() => {
                  dx = nextDirection.dx; dy = nextDirection.dy;
                  ctx.fillStyle = currentTheme.bg; ctx.fillRect(0, 0, 800, 600);
                  
                  let nX = snake[0].x + dx, nY = snake[0].y + dy;
                  if (nX < 0) nX = 780; else if (nX >= 800) nX = 0;
                  if (nY < 0) nY = 580; else if (nY >= 600) nY = 0;

                  const hitH = hurdles.some(h => nX >= h.x && nX < h.x + 40 && nY >= h.y && nY < h.y + 40);
                  if (snake.some(p => p.x === nX && p.y === nY) || hitH) { handleGameOver(); return; }

                  // Toxic Logic
                  let dist = Math.sqrt(Math.pow(nX - foodX, 2) + Math.pow(nY - foodY, 2));
                  if (dist < 40) wasNear = true;
                  else if (wasNear && dist > 70) {
                      toxicity = Math.min(100, toxicity + 20); missCombo++;
                      if (missCombo >= 2) { chatMsg = missRoasts[Math.floor(Math.random()*missRoasts.length)]; chatTimer = 20; }
                      wasNear = false;
                  }
                  
                  isRage = toxicity >= 100;
                  document.getElementById("toxic-bar").style.height = toxicity + "%";
                  
                  // Drawing
                  ctx.fillStyle = currentTheme.hurdle;
                  hurdles.forEach(h => { ctx.fillRect(h.x, h.y, 40, 40); ctx.strokeStyle=currentTheme.snake; ctx.strokeRect(h.x+4, h.y+4, 32, 32); });

                  snake.unshift({x: nX, y: nY});
                  if (nX === foodX && nY === foodY) {
                      totalScore += 10; toxicity = Math.max(0, toxicity - 35);
                      playSfx("eatSound"); document.getElementById("scoreVal").innerText = totalScore;
                      if (totalScore % 50 === 0) { currentLevel++; document.getElementById("levelVal").innerText = currentLevel; changeMap(); }
                      createFood();
                  } else { snake.pop(); }

                  snake.forEach((p, i) => {
                      ctx.fillStyle = isRage ? "#ff0055" : (i === 0 ? currentTheme.snake : currentTheme.body);
                      ctx.fillRect(p.x, p.y, 18, 18);
                  });

                  ctx.fillStyle = isRage ? "#ff0055" : currentTheme.snake;
                  ctx.beginPath(); ctx.arc(foodX+10, foodY+10, 8, 0, Math.PI*2); ctx.fill();

                  if (chatTimer > 0) { ctx.fillStyle = "white"; ctx.font = "bold 16px Arial"; ctx.fillText(chatMsg, snake[0].x, snake[0].y-15); chatTimer--; }

                  gameLoop();
              }, speed);
          }

          function createFood() { foodX = Math.floor(Math.random()*39)*20; foodY = Math.floor(Math.random()*29)*20; wasNear = false; }
          
          async function handleGameOver() {
              gameRunning = false; playSfx("deathSound");
              document.getElementById("over-roast").innerText = crashRoasts[Math.floor(Math.random()*crashRoasts.length)];
              document.getElementById("over-score").innerText = "SCORE: " + totalScore;
              document.getElementById("game-over-screen").style.display = "block";
              await fetch(`${DB_URL}scores/${currentPlayer.toLowerCase()}.json`, { method: 'PUT', body: JSON.stringify({ name: currentPlayer, score: totalScore }) });
          }

          function togglePause() { isPaused = !isPaused; document.getElementById("pause-overlay").style.display = isPaused ? "block" : "none"; if(!isPaused) gameLoop(); }
          function shareToWhatsApp() { window.open(`https://wa.me/?text=üêç I scored ${totalScore} on The Snake! Beat me if you can!`, '_blank'); }

          document.addEventListener("keydown", e => {
              if (e.keyCode === 37 && dx === 0) setDir(-20, 0);
              if (e.keyCode === 38 && dy === 0) setDir(0, -20);
              if (e.keyCode === 39 && dx === 0) setDir(20, 0);
              if (e.keyCode === 40 && dy === 0) setDir(0, 20);
          });

          window.onload = fetchGlobalHigh;
     </script>
</body>
</html>
