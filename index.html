<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>The Snake - Saboor's Global Rage</title>
     <style>
          body {
              background-color: #0d0221;
              display: flex; flex-direction: column; align-items: center; justify-content: center;
              min-height: 100vh; margin: 0; color: #00f2ff;
              font-family: 'Courier New', Courier, monospace;
              overflow: hidden; user-select: none;
          }
          #start-screen, #pause-overlay, #leaderboard-screen, #game-over-screen, #invite-notif {
              position: absolute; background: rgba(15, 5, 36, 0.98);
              padding: 40px; border: 3px solid #00f2ff; text-align: center;
              z-index: 100; box-shadow: 0 0 50px #00f2ff;
          }
          #pause-overlay, #leaderboard-screen, #game-over-screen, #invite-notif { display: none; }
          #leaderboard-screen { width: 380px; max-height: 80vh; overflow-y: auto; }
          .credits {
              position: absolute; bottom: 10px; right: 15px;
              font-size: 12px; color: #00f2ff; opacity: 0.7;
              text-shadow: 0 0 5px #00f2ff;
          }
          .toxic-wrapper {
              position: absolute; right: -30px; display: none;
              flex-direction: column; align-items: center;
          }
          .toxic-label {
              font-size: 10px; font-weight: bold; color: #ff0055;
              margin-bottom: 5px; text-transform: uppercase;
              writing-mode: vertical-rl; transform: rotate(180deg);
          }
          .toxic-container-vertical {
              width: 10px; height: 300px; background: #1a1a3a; 
              border: 2px solid #00f2ff; border-radius: 10px; 
              position: relative; display: flex; flex-direction: column; 
              justify-content: flex-end; overflow: hidden;
          }
          #toxic-bar {
              width: 100%; height: 0%;
              background: linear-gradient(0deg, #00f2ff, #ff0055);
              transition: height 0.3s ease;
          }
          input {
              background: #16213e; border: 2px solid #00f2ff; color: white;
              padding: 12px; margin-bottom: 25px; width: 220px;
              text-align: center; font-size: 18px; outline: none;
              display: block; margin: 20px auto;
          }
          button {
              background: #ff0055; color: white; border: none;
              padding: 15px 35px; font-weight: bold; font-size: 20px;
              cursor: pointer; text-transform: uppercase; margin: 5px;
          }
          .whatsapp-btn { background: #25D366; }
          .stats-bar {
              display: flex; justify-content: space-between;
              width: 800px; padding: 10px 20px; font-size: 18px;
              background: rgba(0, 242, 255, 0.1); margin-bottom: 10px;
          }
          canvas { background-color: #0f0524; border: 4px solid #00f2ff; }
          #leaderboard-list { list-style: none; padding: 0; text-align: left; margin: 20px 0; font-size: 14px;}
          .lb-item { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding: 8px 0; cursor: pointer; }
          .lb-item:hover { background: rgba(0,242,255,0.1); }
          .lb-header { color: #ff0055; font-weight: bold; margin-top: 15px; border-bottom: 2px solid #ff0055; }
          .mvp-crown { color: gold; font-size: 18px; text-shadow: 0 0 10px gold; }
          .online-dot { height: 8px; width: 8px; background-color: #25D366; border-radius: 50%; display: inline-block; margin-right: 5px; }
     </style>
</head>
<body>
     
     <audio id="bgMusic" loop src="music.mp3"></audio>
     <audio id="eatSound" src="eat.mp3" preload="auto"></audio>
     <audio id="deathSound" src="death.mp3" preload="auto"></audio>

     <div id="invite-notif">
         <h3 id="invite-msg">Player wants 1v1!</h3>
         <button onclick="accept1v1()">ACCEPT CHALLENGE</button>
         <button onclick="decline1v1()" style="background:#555">DECLINE</button>
     </div>

     <div id="start-screen">
          <h1 style="font-size: 50px; margin:0; letter-spacing: 5px;">THE SNAKE</h1>
          <input type="text" id="playerName" placeholder="Name" maxlength="12">
          <button onclick="attemptStart()">START GAME ‚ö°</button>
          <button onclick="showLeaderboard()">LEADERBOARD üèÜ</button>
          <div class="credits">Created by Saboor üç≠</div>
     </div>

     <div id="leaderboard-screen">
          <h2 style="color:#00f2ff;">HALL OF FAME</h2>
          <p style="font-size:10px">Click an online player to Challenge ‚öîÔ∏è</p>
          <div id="leaderboard-list">Loading players...</div>
          <button onclick="document.getElementById('leaderboard-screen').style.display='none'">CLOSE</button>
     </div>

     <div id="game-over-screen">
          <h1 id="over-title">GAME OVER</h1>
          <p id="over-roast" style="color: #ff0055; font-weight: bold; font-size: 18px;"></p>
          <h2 id="over-score">SCORE: 0</h2>
          <button onclick="location.reload()">TRY AGAIN</button>
          <button class="whatsapp-btn" onclick="shareToWhatsApp()">SHARE TO WHATSAPP üì≤</button>
     </div>

     <div class="stats-bar">
          <div>SCORE: <span id="scoreVal">0</span> <span id="vsScore" style="display:none">| P2: <span id="p2ScoreVal">0</span></span></div>
          <div style="color: #ff0055;">WR: <span id="highScoreVal">0</span> BY <span id="highScoreName">NONE</span></div>
     </div>

     <div class="main-container">
          <canvas id="gameCanvas" width="800" height="600"></canvas>
          <div class="toxic-wrapper" id="toxic-ui">
              <div class="toxic-label">TOXICITY</div>
              <div class="toxic-container-vertical">
                  <div id="toxic-bar"></div>
              </div>
          </div>
     </div>

     <script>
          const DB_URL = "https://snake-competition-default-rtdb.firebaseio.com/";
          const canvas = document.getElementById("gameCanvas");
          const ctx = canvas.getContext("2d");

          // ALL ORIGINAL ROASTS RESTORED
          const startRoasts = ["Type a name, you uneducated walnut!", "Are you allergic to keyboards?", "Name box is empty, just like your future.", "Identify yourself so I know who to laugh at.", "Is your brain on airplane mode?", "Error 404: Player's identity not found.", "Even a goldfish has a name. What's yours?", "Enter a name or go back to nursery school.", "Hurry up, I'm losing CPU cycles!", "Type something! Anything! You useless brick!", "The input box isn't a mirror, don't just stare.", "Waiting for a name... any century now.", "I can't track your failures without a name.", "A name. 3 letters. Can you manage that?", "Your keyboard is for typing, not drooling.", "Is this too complex for you already?", "Don't be shy, we already know you're bad.", "Name. Now. Don't make me ask again.", "System waiting for a human. Only found a potato.", "Loading... oh wait, YOU haven't typed yet.", "Just pick a name and lose already.", "The snake is hungry, and you're wasting time.", "Enter a name to begin your humiliation.", "Does your mom know you're this slow?", "If you can't type a name, don't try the game.", "Input required. Intelligence not expected.", "Stop staring and start typing.", "Who are you? Nobody? Thought so.", "My code is faster than your brain.", "I'm literally falling asleep here."];
          const crashRoasts = ["PATHETIC. JUST UNINSTALL.", "THAT WALL HAD A FAMILY!", "SCORE LOWER THAN YOUR IQ.", "EVEN THE SNAKE IS DISAPPOINTED.", "WAS THAT A COLLISION OR A CRY FOR HELP?", "RESTARTING WON'T FIX YOUR SKILL ISSUE.", "EMBARRASSING. TRULY.", "DO YOU NEED GLASSES?", "A POTATO HAS BETTER REFLEXES.", "MY CAT WALKED ON THE KEYS AND DID BETTER.", "IF LOSING WAS AN OLYMPIC SPORT, YOU'D HAVE GOLD.", "YOU'RE THE REASON SHAMPOO HAS INSTRUCTIONS.", "I'VE SEEN BREAD PLAY BETTER THAN THIS.", "GO PLAY TETRIS, THIS IS TOO FAST FOR YOU.", "THE SNAKE DIED OF SHAME, NOT THE WALL.", "STOP WASTING ELECTRICITY.", "BRAVO! You hit the only thing you were supposed to avoid.", "I'D CALL YOU TRASH BUT TRASH CAN BE RECYCLED.", "THAT WAS PHYSICALLY PAINFUL TO WATCH.", "IS YOUR MONITOR EVEN ON?", "YOU FAILED. AGAIN. SURPRISE SURPRISE.", "MAYBE TRY LUDO? IT'S TURN-BASED.", "DON'T CRY. JUST GET BETTER.", "CLOWN BEHAVIOR.", "ARE YOU TIRED? BECAUSE THAT WAS LAZY.", "SNAKE GO CRASH. USER GO CRY.", "ABSOLUTE GARBAGE.", "MY GRANDMA PLAYS FASTER.", "YOU HIT THE WALL LIKE IT OWED YOU MONEY.", "ERROR: SKILL NOT FOUND.", "LOGIC NOT FOUND.", "TRY USING YOUR HANDS NEXT TIME.", "DO YOU ENJOY LOSING?", "TRAGIC. SIMPLY TRAGIC.", "SADDEST ATTEMPT OF THE DAY.", "YOU'RE NOT BUILT FOR THIS.", "QUITTING IS ALWAYS AN OPTION.", "YOU'RE LAGGING IN REAL LIFE.", "I'VE SEEN BOTS WITH MORE SOUL.", "JUST... WOW. BAD."];
          const backhandedPraise = ["NEW RECORD! Finally the smartest among the idiots.", "HIGH SCORE! Mom is so proud of her basement dweller.", "NEW RECORD! Luck is a powerful thing for the brainless.", "WOW, YOU BEAT IT! Too bad you'll never be this good at life.", "NEW HIGH SCORE! Enjoy your 5 seconds of meaningless glory."];
          const missRoasts = ["EMOTIONAL DAMAGE!", "WHEEZE... MISS?!", "NICE WHIFF!", "LMAO, TRASH.", "DID YOU BLINK?", "SNAIL!", "GIT GUD.", "STAY MAD."];

          let snake = [{x: 400, y: 300}, {x: 380, y: 300}, {x: 360, y: 300}];
          let snake2 = [];
          let dx = 20, dy = 0, nextDir = {dx: 20, dy: 0};
          let totalScore = 0, p2Score = 0, gameRunning = false, currentPlayer = "", myId = "";
          let foodX, foodY, toxicity = 0, chatTimer = 0, chatMsg = "", is1v1 = false, roomKey = "", opponentId = "";

          // 1V1 INVITE LISTENER
          setInterval(async () => {
              if (myId && !is1v1) {
                  const r = await fetch(`${DB_URL}invites/${myId}.json`);
                  const inv = await r.json();
                  if (inv) {
                      opponentId = inv.from;
                      roomKey = inv.room;
                      document.getElementById("invite-msg").innerText = inv.fromName + " challenges you!";
                      document.getElementById("invite-notif").style.display = "block";
                  }
              }
          }, 2000);

          function attemptStart() {
              const name = document.getElementById("playerName").value.trim();
              if (name.length < 2) { 
                  alert(startRoasts[Math.floor(Math.random()*startRoasts.length)]);
                  return;
              }
              currentPlayer = name;
              myId = name.toLowerCase().replace(/\s/g, '');
              updateStatus("online");
              document.getElementById("bgMusic").play().catch(e=>{});
              document.getElementById("start-screen").style.display = "none";
              document.getElementById("toxic-ui").style.display = "flex";
              gameRunning = true;
              createFood();
              gameLoop();
          }

          async function showLeaderboard() {
              document.getElementById("leaderboard-screen").style.display = "block";
              const list = document.getElementById("leaderboard-list");
              list.innerHTML = "Fetching Hall of Fame...";
              
              const [sRes, uRes] = await Promise.all([fetch(`${DB_URL}scores.json`), fetch(`${DB_URL}users.json`)]);
              const scores = await sRes.json();
              const users = await uRes.json();
              
              if (scores) {
                  const sorted = Object.values(scores).sort((a,b) => b.score - a.score);
                  let html = `<div class="lb-header">TOP 5 LEGENDS</div>`;
                  sorted.forEach((s, i) => {
                      const id = s.name.toLowerCase().replace(/\s/g, '');
                      const isOnline = users && users[id] && users[id].status === 'online';
                      const crown = i === 0 ? `<span class="mvp-crown"> üëë MVP</span>` : '';
                      html += `<div class="lb-item" onclick="sendInvite('${id}', '${s.name}')">
                          <span>${isOnline ? '<span class="online-dot"></span>':''}${i+1}. ${s.name}${crown}</span>
                          <span>${s.score}</span>
                      </div>`;
                  });
                  list.innerHTML = html;
              }
          }

          async function sendInvite(id, name) {
              if (id === myId) return;
              roomKey = [myId, id].sort().join("_v_");
              await fetch(`${DB_URL}invites/${id}.json`, {
                  method: 'PUT',
                  body: JSON.stringify({ from: myId, fromName: currentPlayer, room: roomKey })
              });
              alert("Request sent to " + name + "! Stay here, the game will start when they accept.");
              
              const check = setInterval(async () => {
                  const r = await fetch(`${DB_URL}rooms/${roomKey}/active.json`);
                  if (await r.json()) { clearInterval(check); start1v1(); }
              }, 2000);
          }

          async function accept1v1() {
              await fetch(`${DB_URL}rooms/${roomKey}/active.json`, { method: 'PUT', body: "true" });
              await fetch(`${DB_URL}invites/${myId}.json`, { method: 'DELETE' });
              document.getElementById("invite-notif").style.display = "none";
              start1v1();
          }

          function decline1v1() {
              fetch(`${DB_URL}invites/${myId}.json`, { method: 'DELETE' });
              document.getElementById("invite-notif").style.display = "none";
          }

          function start1v1() {
              is1v1 = true; gameRunning = true;
              document.getElementById("vsScore").style.display = "inline";
              document.getElementById("start-screen").style.display = "none";
              document.getElementById("leaderboard-screen").style.display = "none";
              
              // Direct Sync
              setInterval(() => {
                  if(!gameRunning) return;
                  fetch(`${DB_URL}rooms/${roomKey}/${myId}.json`, { method: 'PUT', body: JSON.stringify({ s: snake, sc: totalScore }) });
              }, 150);
              
              setInterval(async () => {
                  if(!gameRunning) return;
                  const r = await fetch(`${DB_URL}rooms/${roomKey}/${opponentId}.json`);
                  const d = await r.json();
                  if(d) { snake2 = d.s; p2Score = d.sc; document.getElementById("p2ScoreVal").innerText = p2Score; }
              }, 150);
              createFood();
              gameLoop();
          }

          function createFood() {
              foodX = Math.floor(Math.random() * 39) * 20;
              foodY = Math.floor(Math.random() * 29) * 20;
          }

          function gameLoop() {
              if (!gameRunning) return;
              let speed = Math.max(50, 150 - (totalScore / 2));
              setTimeout(() => {
                  dx = nextDir.dx; dy = nextDir.dy;
                  ctx.fillStyle = "#0f0524"; ctx.fillRect(0,0,800,600);
                  
                  let head = { x: snake[0].x + dx, y: snake[0].y + dy };
                  if (head.x < 0) head.x = 780; else if (head.x >= 800) head.x = 0;
                  if (head.y < 0) head.y = 580; else if (head.y >= 600) head.y = 0;

                  if (snake.slice(1).some(p => p.x === head.x && p.y === head.y)) { handleGameOver(); return; }
                  snake.unshift(head);

                  if (head.x === foodX && head.y === foodY) {
                      totalScore += 10; toxicity = Math.max(0, toxicity - 30);
                      document.getElementById("scoreVal").innerText = totalScore;
                      document.getElementById("eatSound").play().catch(e=>{});
                      createFood();
                  } else { 
                      snake.pop(); 
                      let dist = Math.sqrt(Math.pow(head.x-foodX,2)+Math.pow(head.y-foodY,2));
                      if(dist < 50) toxicity += 0.5;
                  }

                  document.getElementById("toxic-bar").style.height = (toxicity % 100) + "%";
                  
                  // Draw Food
                  ctx.fillStyle = "#ff0055"; ctx.beginPath(); ctx.arc(foodX+10, foodY+10, 8, 0, Math.PI*2); ctx.fill();
                  
                  // Draw Me
                  snake.forEach((p, i) => {
                      ctx.fillStyle = i === 0 ? "#00f2ff" : "#7000ff";
                      ctx.fillRect(p.x, p.y, 18, 18);
                  });

                  // Draw Opponent
                  if(is1v1) {
                      snake2.forEach((p, i) => {
                          ctx.fillStyle = i === 0 ? "#ff0055" : "#444";
                          ctx.fillRect(p.x, p.y, 18, 18);
                      });
                  }

                  gameLoop();
              }, speed);
          }

          function handleGameOver() {
              gameRunning = false;
              document.getElementById("deathSound").play().catch(e=>{});
              if(!is1v1) saveScore(currentPlayer, totalScore);
              
              document.getElementById("over-roast").innerText = crashRoasts[Math.floor(Math.random()*crashRoasts.length)];
              document.getElementById("over-score").innerText = "SCORE: " + totalScore;
              document.getElementById("game-over-screen").style.display = "block";
          }

          async function saveScore(n, s) {
              await fetch(`${DB_URL}scores/${myId}.json`, { method: 'PUT', body: JSON.stringify({ name: n, score: s }) });
          }

          function updateStatus(s) {
              if(myId) fetch(`${DB_URL}users/${myId}.json`, { method: 'PATCH', body: JSON.stringify({ status: s }) });
          }

          function shareToWhatsApp() {
              const text = `üêç THE SNAKE GAME üêç\nScore: ${totalScore}\nChallenge: ${window.location.href}`;
              window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
          }

          document.addEventListener("keydown", e => {
              if (e.keyCode === 37 && dx === 0) nextDir = { dx: -20, dy: 0 };
              if (e.keyCode === 38 && dy === 0) nextDir = { dx: 0, dy: -20 };
              if (e.keyCode === 39 && dx === 0) nextDir = { dx: 20, dy: 0 };
              if (e.keyCode === 40 && dy === 0) nextDir = { dx: 0, dy: 20 };
          });

          window.onbeforeunload = () => updateStatus("offline");
          
          // Initial Load WR
          fetch(`${DB_URL}scores.json`).then(r => r.json()).then(d => {
              if(d) {
                  const sorted = Object.values(d).sort((a,b)=>b.score-a.score);
                  document.getElementById("highScoreVal").innerText = sorted[0].score;
                  document.getElementById("highScoreName").innerText = sorted[0].name.toUpperCase();
              }
          });
     </script>
</body>
</html>
