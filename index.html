<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Snake - Saboor's Global Rage</title>
    <style>
        body {
            background-color: #0d0221;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; color: #00f2ff;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden; user-select: none;
        }
        #start-screen, #pause-overlay, #leaderboard-screen, #game-over-screen {
            position: absolute; background: rgba(15, 5, 36, 0.98);
            padding: 40px; border: 3px solid #00f2ff; text-align: center;
            z-index: 100; box-shadow: 0 0 50px #00f2ff;
        }
        #pause-overlay, #leaderboard-screen, #game-over-screen { display: none; }
        
        #leaderboard-screen { width: 400px; max-height: 80vh; overflow-y: auto; }

        .credits { position: absolute; bottom: 10px; right: 15px; font-size: 12px; color: #00f2ff; opacity: 0.7; }

        .audio-controls {
            position: absolute; top: 10px; right: 10px; display: flex; gap: 10px; z-index: 200;
        }
        .audio-btn {
            width: 45px; height: 45px; border-radius: 50%; border: 2px solid #00f2ff;
            background: rgba(0,0,0,0.5); color: #00f2ff; cursor: pointer; font-size: 20px;
            display: flex; align-items: center; justify-content: center; transition: 0.3s;
        }
        .audio-btn:hover { background: #00f2ff; color: #0d0221; }

        .toxic-wrapper {
            position: absolute; right: -35px; display: none; flex-direction: column; align-items: center;
        }
        .toxic-label {
            font-size: 10px; font-weight: bold; color: #ff0055; margin-bottom: 5px;
            text-transform: uppercase; writing-mode: vertical-rl; transform: rotate(180deg);
        }
        .toxic-container-vertical {
            width: 12px; height: 300px; background: #1a1a3a; border: 2px solid #00f2ff;
            border-radius: 10px; position: relative; display: flex; flex-direction: column; justify-content: flex-end; overflow: hidden;
        }
        #toxic-bar { width: 100%; height: 0%; background: linear-gradient(0deg, #00f2ff, #ff0055); transition: height 0.3s; }

        input {
            background: #16213e; border: 2px solid #00f2ff; color: white;
            padding: 12px; margin-bottom: 25px; width: 250px; text-align: center; font-size: 18px; outline: none;
        }
        button {
            background: #ff0055; color: white; border: none; padding: 15px 35px;
            font-weight: bold; font-size: 18px; cursor: pointer; text-transform: uppercase; margin: 5px; transition: 0.2s;
        }
        button:hover { transform: scale(1.05); filter: brightness(1.2); }
        .whatsapp-btn { background: #25D366; }

        .stats-bar {
            display: flex; justify-content: space-between; width: 800px; padding: 10px 20px;
            font-size: 18px; background: rgba(0, 242, 255, 0.1); margin-bottom: 10px; border: 1px solid #00f2ff;
        }
        canvas { background-color: #0f0524; border: 4px solid #00f2ff; box-shadow: 0 0 20px rgba(0, 242, 255, 0.2); }

        .lb-item { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 10px 5px; }
        .lb-header { color: #ff0055; font-weight: bold; margin-top: 15px; border-bottom: 2px solid #ff0055; padding-bottom: 5px; }
    </style>
</head>
<body>

    <div class="audio-controls">
        <button class="audio-btn" onclick="btnClick(); toggleMusic()" id="musicBtn" title="Toggle Music">üéµ</button>
        <button class="audio-btn" onclick="btnClick(); toggleSFX()" id="sfxBtn" title="Toggle SFX">üîä</button>
    </div>

    <div id="start-screen">
        <h1 style="font-size: 60px; margin:0; letter-spacing: 8px; color:#ff0055;">THE SNAKE</h1>
        <p style="margin-top:0; color:#00f2ff;">JUST A QUICK PLAY</p>
        <input type="text" id="playerName" placeholder="NAME" maxlength="12">
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="btnClick(); attemptStart()">Quick Start ‚ö°</button>
            <button onclick="btnClick(); showLeaderboard()">LEADERBOARD üèÜ</button>
        </div>
        <div class="credits">Created by Saboor üç≠</div>
    </div>

    <div id="leaderboard-screen">
        <h2 style="color:#00f2ff; letter-spacing: 3px;">HALL OF FAME</h2>
        <div id="leaderboard-list">Loading Legends...</div>
        <button onclick="btnClick(); closeLeaderboard()" style="margin-top:20px;">BACK TO MENU</button>
    </div>

    <div id="game-over-screen">
        <h1 id="over-title" style="font-size: 40px; color:#ff0055;">GAME OVER</h1>
        <p id="over-roast" style="color: #00f2ff; font-weight: bold; font-size: 18px; min-height: 50px; padding: 0 20px;"></p>
        <h2 id="over-score" style="font-size: 30px;">SCORE: 0</h2>
        <div style="display:flex; flex-direction:column; gap:10px;">
            <button onclick="btnClick(); location.reload()">RETRY</button>
            <button class="whatsapp-btn" onclick="btnClick(); shareToWhatsApp()">SHARE ON WHATSAPP üì≤</button>
        </div>
    </div>

    <div id="pause-overlay">
        <h1 style="font-size: 50px; color:#00f2ff;">PAUSED</h1>
        <button onclick="btnClick(); togglePause()">RESUME (P)</button>
    </div>

    <div class="stats-bar">
        <div>SCORE: <span id="scoreVal" style="color:#fff;">0</span></div>
        <div style="color: #ff0055;">WORLD RECORD: <span id="highScoreVal">0</span> BY <span id="highScoreName">NONE</span></div>
    </div>

    <div class="main-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="toxic-wrapper" id="toxic-ui">
            <div class="toxic-label">TOXICITY</div>
            <div class="toxic-container-vertical"><div id="toxic-bar"></div></div>
        </div>
    </div>

    <script>
        // --- CONFIG & DB ---
        const DB_URL = "https://snake-competition-default-rtdb.firebaseio.com/";
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // --- FULL ROAST LIBRARIES (NO SKIPPING) ---
        const startRoasts = [
            "Type a name, you uneducated walnut!", "Are you allergic to keyboards?", "Name box is empty, just like your future.",
            "Identify yourself so I know who to laugh at.", "Is your brain on airplane mode?", "Error 404: Player's identity not found.",
            "Even a goldfish has a name. What's yours?", "Hurry up, I'm losing CPU cycles!", "Wait... can you even read?",
            "Type something! Anything! You useless brick!", "Your keyboard is for typing, not drooling."
        ];

        const crashRoasts = [
            "PATHETIC. JUST UNINSTALL.", "THAT WALL HAD A FAMILY!", "SCORE LOWER THAN YOUR IQ.", "EVEN THE SNAKE IS DISAPPOINTED.",
            "WAS THAT A COLLISION OR A CRY FOR HELP?", "RESTARTING WON'T FIX YOUR SKILL ISSUE.", "EMBARRASSING. TRULY.",
            "A POTATO HAS BETTER REFLEXES.", "MY CAT WALKED ON THE KEYS AND DID BETTER.", "IF LOSING WAS AN OLYMPIC SPORT, YOU'D HAVE GOLD.",
            "GO PLAY TETRIS, THIS IS TOO FAST FOR YOU.", "I'D CALL YOU TRASH BUT TRASH CAN BE RECYCLED.", "IS YOUR MONITOR EVEN ON?",
            "ERROR: SKILL NOT FOUND.", "TRY USING YOUR HANDS NEXT TIME.", "CLOWN BEHAVIOR."
        ];

        const backhandedPraise = [
            "NEW RECORD! Finally the smartest among the idiots.", "HIGH SCORE! Mom is so proud of her basement dweller.",
            "WOW, YOU BEAT IT! Too bad you'll never be this good at life.", "NEW RECORD! You're officially the king of losers.",
            "AMAZING! You finally did something other than failing.", "NEW RECORD! Now try doing that in real life."
        ];

        const missRoasts = [
            "EMOTIONAL DAMAGE!", "WHEEZE... MISS?!", "NICE WHIFF!", "LMAO, TRASH.", "DID YOU BLINK?", "SNAIL!", "GIT GUD.",
            "APPLE REJECTED YOU!", "ARE YOU PLAYING WITH YOUR TOES?", "WHOOSH!", "AIR BALL!", "ALMOST... BUT NO."
        ];

        // --- STATE ---
        let snake = [{x: 400, y: 300}, {x: 380, y: 300}, {x: 360, y: 300}];
        let dx = 20, dy = 0, nextDx = 20, nextDy = 0;
        let totalScore = 0, gameRunning = false, isPaused = false;
        let foodX, foodY, toxicity = 0, isRage = false;
        let chatTimer = 0, chatMsg = "", wasNear = false, missCombo = 0, currentPlayer = "";
        let finalRoastMessage = "", globalBestScore = 0, globalBestName = "---";
        let musicEnabled = true, sfxEnabled = true;

        // --- AUDIO ENGINE ---
        let audioCtx, musicOsc, musicGain, sfxGain;
        
        function initAudio() {
            if (audioCtx) return;
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            musicGain = audioCtx.createGain();
            sfxGain = audioCtx.createGain();
            musicGain.connect(audioCtx.destination);
            sfxGain.connect(audioCtx.destination);
            startBgMusic();
        }

        function btnClick() { playSound(400, 800, 0.05, 0.1); }

        function playSound(f1, f2, dur, vol) {
            if (!sfxEnabled || !audioCtx) return;
            const o = audioCtx.createOscillator();
            const g = audioCtx.createGain();
            o.frequency.setValueAtTime(f1, audioCtx.currentTime);
            o.frequency.exponentialRampToValueAtTime(f2, audioCtx.currentTime + dur);
            g.gain.setValueAtTime(vol, audioCtx.currentTime);
            g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + dur);
            o.connect(g); g.connect(sfxGain);
            o.start(); o.stop(audioCtx.currentTime + dur);
        }

        function startBgMusic() {
            if (!musicEnabled) return;
            if (musicOsc) musicOsc.stop();
            musicOsc = audioCtx.createOscillator();
            musicOsc.type = 'sawtooth';
            musicOsc.frequency.setValueAtTime(55, audioCtx.currentTime); // Deep bass
            musicGain.gain.setValueAtTime(0.03, audioCtx.currentTime);
            musicOsc.connect(musicGain);
            musicOsc.start();
        }

        function updateMusicTempo() {
            if (!musicOsc || !musicEnabled) return;
            // Frequency increases with score and toxicity
            let baseFreq = 55 + (totalScore / 5);
            if (isRage) baseFreq += 30;
            musicOsc.frequency.setTargetAtTime(baseFreq, audioCtx.currentTime, 0.5);
        }

        function toggleMusic() {
            musicEnabled = !musicEnabled;
            document.getElementById("musicBtn").innerText = musicEnabled ? "üéµ" : "üîá";
            if (musicGain) musicGain.gain.setTargetAtTime(musicEnabled ? 0.03 : 0, audioCtx.currentTime, 0.1);
        }
        function toggleSFX() {
            sfxEnabled = !sfxEnabled;
            document.getElementById("sfxBtn").innerText = sfxEnabled ? "üîä" : "üîá";
        }

        // --- CORE LOGIC ---
        async function fetchGlobalHigh() {
            try {
                const res = await fetch(DB_URL + "scores.json");
                const data = await res.json();
                if (data) {
                    const sorted = Object.values(data).sort((a,b) => b.score - a.score);
                    globalBestScore = sorted[0].score;
                    globalBestName = sorted[0].name;
                    document.getElementById("highScoreVal").innerText = globalBestScore;
                    document.getElementById("highScoreName").innerText = globalBestName.toUpperCase();
                }
            } catch(e) {}
        }

        async function saveScore(name, score) {
            if (!name || name === "---" || score <= 0) return;
            const id = name.toLowerCase().trim();
            try {
                const res = await fetch(`${DB_URL}scores/${id}.json`);
                const existing = await res.json();
                if (!existing || score > existing.score) {
                    await fetch(`${DB_URL}scores/${id}.json`, {
                        method: 'PUT', body: JSON.stringify({name, score})
                    });
                }
            } catch(e) {}
        }

        function attemptStart() {
            const name = document.getElementById("playerName").value.trim();
            if (name.length < 2) { 
                alert(startRoasts[Math.floor(Math.random()*startRoasts.length)]); 
                return; 
            }
            currentPlayer = name;
            initAudio();
            document.getElementById("start-screen").style.display = "none";
            document.getElementById("toxic-ui").style.display = "flex";
            gameRunning = true;
            createFood();
            gameLoop();
        }

        function createFood() {
            foodX = Math.floor(Math.random() * 39) * 20;
            foodY = Math.floor(Math.random() * 29) * 20;
            wasNear = false;
        }

        function gameLoop() {
            if (!gameRunning || isPaused) return;
            
            // APPLY BUFFERED INPUT
            dx = nextDx; dy = nextDy;
            
            let speed = isRage ? 45 : Math.max(50, 150 - (totalScore/2));
            updateMusicTempo();

            setTimeout(() => {
                ctx.fillStyle = "#0f0524"; ctx.fillRect(0, 0, 800, 600);
                let head = { x: snake[0].x + dx, y: snake[0].y + dy };

                // Miss Detection
                let dist = Math.sqrt((head.x-foodX)**2 + (head.y-foodY)**2);
                if (dist < 45) wasNear = true;
                else if (wasNear && dist > 55) {
                    toxicity = Math.min(100, toxicity + 20);
                    missCombo++;
                    if (missCombo >= 2) { 
                        chatMsg = missRoasts[Math.floor(Math.random()*missRoasts.length)]; 
                        chatTimer = 25; 
                    }
                    wasNear = false;
                }

                snake.unshift(head);
                if (head.x === foodX && head.y === foodY) {
                    totalScore += 10; toxicity = Math.max(0, toxicity - 40);
                    missCombo = 0; playSound(600, 1200, 0.1, 0.2);
                    document.getElementById("scoreVal").innerText = totalScore;
                    createFood();
                    fetchGlobalHigh();
                } else { snake.pop(); }

                // Death Logic
                if (head.x < 0 || head.x >= 800 || head.y < 0 || head.y >= 600 || snake.slice(1).some(p => p.x === head.x && p.y === head.y)) {
                    handleGameOver(); return;
                }

                isRage = toxicity >= 100;
                document.getElementById("toxic-bar").style.height = toxicity + "%";

                // Draw Food
                ctx.shadowBlur = 15; ctx.shadowColor = isRage ? "#ff0055" : "#00f2ff";
                ctx.fillStyle = isRage ? "#ff0055" : "#00f2ff";
                ctx.beginPath(); ctx.arc(foodX+10, foodY+10, 9, 0, Math.PI*2); ctx.fill();
                ctx.shadowBlur = 0;

                // Draw Snake
                snake.forEach((p, i) => {
                    ctx.fillStyle = isRage ? "#ff0055" : (i === 0 ? "#00f2ff" : "#7000ff");
                    ctx.fillRect(p.x, p.y, 18, 18);
                    if (i === 0 && currentPlayer.toLowerCase() === globalBestName.toLowerCase()) {
                        ctx.fillStyle = "gold"; ctx.fillText("üëë", p.x+4, p.y-5);
                    }
                });

                if (chatTimer-- > 0) {
                    ctx.fillStyle = "#ff0055"; ctx.font = "bold 14px Courier New";
                    ctx.fillText(chatMsg, snake[0].x - 10, snake[0].y - 15);
                }
                gameLoop();
            }, speed);
        }

        async function handleGameOver() {
            gameRunning = false;
            playSound(200, 50, 0.4, 0.3);
            
            if (totalScore > globalBestScore && totalScore > 0) {
                finalRoastMessage = backhandedPraise[Math.floor(Math.random()*backhandedPraise.length)];
            } else {
                finalRoastMessage = crashRoasts[Math.floor(Math.random()*crashRoasts.length)];
            }

            document.getElementById("over-roast").innerText = finalRoastMessage;
            document.getElementById("over-score").innerText = "SCORE: " + totalScore;
            document.getElementById("game-over-screen").style.display = "block";
            await saveScore(currentPlayer, totalScore);
        }

        function shareToWhatsApp() {
            const url = window.location.href;
            const text = totalScore >= globalBestScore 
                ? `üëë NEW RECORD! I scored ${totalScore} on The Snake! Can you beat me? ${url}`
                : `üêç I scored ${totalScore} on The Snake and got roasted: "${finalRoastMessage}" Play here: ${url}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
        }

        function togglePause() {
            if(!gameRunning) return;
            isPaused = !isPaused;
            document.getElementById("pause-overlay").style.display = isPaused ? "block" : "none";
            if(!isPaused) gameLoop();
        }

        async function showLeaderboard() {
            document.getElementById("leaderboard-screen").style.display = "block";
            const list = document.getElementById("leaderboard-list");
            list.innerHTML = "Syncing with Saboor's Server...";
            try {
                const res = await fetch(DB_URL + "scores.json");
                const data = await res.json();
                if (data) {
                    const sorted = Object.values(data).sort((a,b) => b.score - a.score);
                    list.innerHTML = sorted.map((s, i) => `
                        <div class="lb-item">
                            <span>${i+1}. ${s.name} ${i===0?'üëë':''}</span>
                            <span style="color:#00f2ff">${s.score}</span>
                        </div>`).join('');
                } else { list.innerHTML = "No legends yet. Be the first!"; }
            } catch(e) { list.innerHTML = "Offline Mode."; }
        }

        function closeLeaderboard() { document.getElementById("leaderboard-screen").style.display = "none"; }

        // --- INPUT HANDLING (THE MULTI-KEY FIX) ---
        document.addEventListener("keydown", e => {
            if (document.activeElement.tagName === "INPUT") return;
            if ([32, 37, 38, 39, 40, 87, 65, 83, 68].includes(e.keyCode)) e.preventDefault();
            
            if (e.keyCode === 80) togglePause();
            if (isPaused || !gameRunning) return;

            // Use nextDx/nextDy to prevent 180-degree self-collisions
            if ((e.keyCode === 37 || e.keyCode === 65) && dx === 0) { nextDx = -20; nextDy = 0; }
            if ((e.keyCode === 38 || e.keyCode === 87) && dy === 0) { nextDx = 0; nextDy = -20; }
            if ((e.keyCode === 39 || e.keyCode === 68) && dx === 0) { nextDx = 20; nextDy = 0; }
            if ((e.keyCode === 40 || e.keyCode === 83) && dy === 0) { nextDx = 0; nextDy = 20; }
        });

        window.onload = fetchGlobalHigh;
    </script>
</body>
</html>


