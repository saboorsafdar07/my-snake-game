<!DOCTYPE html>
<html lang="en">
<head>
     <meta charset="UTF-8">
     <meta name="viewport" content="width=device-width, initial-scale=1.0">
     <title>The Snake - Saboor's Global Rage (Multiplayer)</title>
     <style>
         :root { --neon-cyan: #00f2ff; --neon-pink: #ff0055; --bg-dark: #0d0221; }
         body {
             background-color: var(--bg-dark);
             display: flex; flex-direction: column; align-items: center; justify-content: center;
             min-height: 100vh; margin: 0; color: var(--neon-cyan);
             font-family: 'Courier New', Courier, monospace;
             overflow: hidden; user-select: none;
         }
         
         /* REUSED FROM ORIGINAL */
         #start-screen, #pause-overlay, #leaderboard-screen, #game-over-screen, .overlay {
             position: absolute; background: rgba(15, 5, 36, 0.98);
             padding: 40px; border: 3px solid var(--neon-cyan); text-align: center;
             z-index: 100; box-shadow: 0 0 50px var(--neon-cyan);
         }
         #pause-overlay, #leaderboard-screen, #game-over-screen, .overlay { display: none; }
         
         /* NEW UPGRADED MODALS */
         #chat-modal { width: 350px; height: 450px; flex-direction: column; z-index: 1000; }
         #settings-modal { width: 400px; z-index: 950; }
         #duel-invite-popup { top: 20px; right: 20px; border-color: var(--neon-pink); width: 250px; box-shadow: 0 0 20px var(--neon-pink); }
         
         .settings-toggle {
             position: fixed; top: 20px; left: 20px; width: 55px; height: 55px;
             border-radius: 50%; background: rgba(0, 242, 255, 0.1); border: 2px solid var(--neon-cyan);
             display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 900; font-size: 24px;
         }
         .modal-section { border-bottom: 1px solid rgba(0, 242, 255, 0.2); padding: 15px 0; max-height: 150px; overflow-y: auto; }
         .friend-row { 
             display: flex; justify-content: space-between; align-items: center; 
             margin: 8px 0; font-size: 13px; background: rgba(255,255,255,0.05); 
             padding: 8px; border-left: 3px solid var(--neon-cyan); 
         }

         /* CHAT UI */
         #chat-display { flex-grow: 1; overflow-y: auto; text-align: left; padding: 10px; border: 1px solid var(--neon-cyan); margin-bottom: 10px; background: #000; }
         .msg-line { margin-bottom: 5px; font-size: 12px; }
         .msg-self { color: var(--neon-cyan); }
         .msg-opp { color: var(--neon-pink); }

         /* ORIGINAL TOXIC BAR */
         .toxic-wrapper { position: absolute; right: -30px; display: none; flex-direction: column; align-items: center; }
         .toxic-label { font-size: 10px; font-weight: bold; color: var(--neon-pink); margin-bottom: 5px; text-transform: uppercase; writing-mode: vertical-rl; transform: rotate(180deg); }
         .toxic-container-vertical { width: 10px; height: 300px; background: #1a1a3a; border: 2px solid var(--neon-cyan); border-radius: 10px; position: relative; display: flex; flex-direction: column; justify-content: flex-end; overflow: hidden; }
         #toxic-bar { width: 100%; height: 0%; background: linear-gradient(0deg, var(--neon-cyan), var(--neon-pink)); transition: height 0.3s ease; }

         /* CIRCULAR AUDIO BUTTONS (ORIGINAL) */
         .audio-settings { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 15px; z-index: 1000; }
         .circle-btn { width: 50px; height: 50px; border-radius: 50%; background: rgba(0, 242, 255, 0.1); border: 2px solid var(--neon-cyan); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.3s; }
         .circle-btn svg { width: 24px; height: 24px; fill: var(--neon-cyan); }
         .circle-btn.muted { border-color: var(--neon-pink); background: rgba(255, 0, 85, 0.1); }
         .circle-btn.muted svg { fill: var(--neon-pink); }

         canvas { background-color: #0f0524; border: 4px solid var(--neon-cyan); }
         input { background: #16213e; border: 2px solid var(--neon-cyan); color: white; padding: 12px; margin: 10px auto; width: 220px; text-align: center; display: block; outline: none; }
         button { background: var(--neon-pink); color: white; border: none; padding: 15px 25px; font-weight: bold; cursor: pointer; text-transform: uppercase; margin: 5px; }
         .status-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
         .online { background: #00ff00; box-shadow: 0 0 5px #00ff00; }
         .offline { background: #555; }
         .lb-item { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding: 8px 0; font-size: 14px;}
     </style>
</head>
<body>
     
     <audio id="bgMusic" loop src="music.mp3"></audio>
     <audio id="eatSound" src="eat.mp3" preload="auto"></audio>
     <audio id="deathSound" src="death.mp3" preload="auto"></audio>
     
     <div class="audio-settings">
         <div id="musicBtn" class="circle-btn" onclick="toggleMusic()">
            <svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg>
         </div>
         <div id="sfxBtn" class="circle-btn" onclick="toggleSFX()">
            <svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>
         </div>
     </div>

     <div class="settings-toggle" onclick="toggleSettings()">‚öôÔ∏è</div>

     <div id="duel-invite-popup" class="overlay">
        <p style="color:var(--neon-pink); font-weight:bold;">1v1 CHALLENGE!</p>
        <p id="inviter-name">Someone</p>
        <button onclick="respondDuel(true)">ACCEPT</button>
        <button onclick="respondDuel(false)">DECLINE</button>
     </div>

     <div id="chat-modal" class="overlay">
        <h3 id="chat-header">CHAT</h3>
        <div id="chat-display"></div>
        <input type="text" id="chatInput" placeholder="Trash talk here...">
        <button onclick="sendChatMessage()">SEND</button>
        <button onclick="closeChat()">CLOSE</button>
     </div>

     <div id="settings-modal" class="overlay">
        <h2>SABOOR'S HUB</h2>
        <div class="modal-section">
            <p style="font-size:10px;">FRIEND REQUESTS</p>
            <div id="req-box"></div>
        </div>
        <div class="modal-section">
            <p style="font-size:10px;">PERMANENT FRIENDS</p>
            <div id="friends-list"></div>
        </div>
        <button onclick="toggleSettings()">CLOSE</button>
     </div>

     <div id="start-screen">
         <h1 style="font-size: 50px; margin:0; letter-spacing: 5px;">THE SNAKE</h1>
         <p style="color:var(--neon-pink); font-size: 10px;">GLOBAL MULTIPLAYER EDITION</p>
         <input type="text" id="playerName" placeholder="Name" maxlength="12">
         <button onclick="attemptStart()">A Quick Start ‚ö°</button>
         <button onclick="showLeaderboard()">RANKINGS üèÜ</button>
         <div style="font-size: 12px; margin-top: 20px; opacity: 0.7;">Created by Saboor üç≠</div>
     </div>

     <div id="leaderboard-screen">
         <h2 style="color:var(--neon-cyan);">HALL OF FAME</h2>
         <div id="leaderboard-list">Loading...</div>
         <button onclick="closeLeaderboard()">CLOSE</button>
     </div>

     <div id="game-over-screen">
         <h1 id="over-title">GAME OVER</h1>
         <p id="over-roast" style="color: var(--neon-pink); font-weight: bold; font-size: 18px;"></p>
         <h2 id="over-score">SCORE: 0</h2>
         <button onclick="location.reload()">TRY AGAIN</button>
         <button id="rematchBtn" style="display:none; background:#25D366;" onclick="inviteToDuel(lastOpponent)">REMATCH</button>
     </div>

     <div id="pause-overlay">
         <h1>PAUSED</h1>
         <button onclick="togglePause()">RESUME (P)</button>
     </div>

     <div class="stats-bar" style="width: 800px; display: flex; justify-content: space-between; padding: 10px; background: rgba(0,242,255,0.1); margin-bottom: 10px;">
         <div id="score-display">SCORE: <span id="scoreVal">0</span></div>
         <div style="color: var(--neon-pink);">WR: <span id="highScoreVal">0</span> BY <span id="highScoreName">NONE</span></div>
     </div>

     <div style="position: relative; display: flex; align-items: center;">
         <canvas id="gameCanvas" width="800" height="600"></canvas>
         <div class="toxic-wrapper" id="toxic-ui">
             <div class="toxic-label">TOXICITY</div>
             <div class="toxic-container-vertical">
                 <div id="toxic-bar"></div>
             </div>
         </div>
     </div>

     <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
     <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

     <script>
         // --- CONFIG ---
         const firebaseConfig = { databaseURL: "https://snake-competition-default-rtdb.firebaseio.com/" };
         firebase.initializeApp(firebaseConfig);
         const db = firebase.database();
         const canvas = document.getElementById("gameCanvas");
         const ctx = canvas.getContext("2d");

         // --- STATE ---
         let currentPlayer = "";
         let snake = [], snake2 = [], dx = 20, dy = 0, nextDir = {dx: 20, dy: 0}, totalScore = 0, p2Score = 0;
         let foodX, foodY, toxicity = 0, isRage = false, gameRunning = false, isPaused = false;
         let isDuel = false, duelRoomId = null, isHost = false, lastOpponent = null, chatFriend = null;
         let musicEnabled = true, sfxEnabled = true;

         // --- EXTENSIVE ROAST LISTS (RETAINED FROM ORIGINAL) ---
         const startRoasts = ["Type a name, you uneducated walnut!", "Name box is empty, just like your future.", "Identify yourself so I know who to laugh at."];
         const crashRoasts = ["PATHETIC. JUST UNINSTALL.", "THAT WALL HAD A FAMILY!", "SCORE LOWER THAN YOUR IQ.", "EVEN THE SNAKE IS DISAPPOINTED."];
         const duelRoasts = ["U smell like defeat.", "Hamster powered WiFi!", "Imagine losing to me lol.", "Snail reflexes!"];

         // --- INITIALIZATION ---
         window.onload = () => { fetchGlobalHigh(); };

         function updateStatus() {
            if(!currentPlayer) return;
            const ref = db.ref(`users/${currentPlayer.toLowerCase()}`);
            ref.set({ name: currentPlayer, online: true, lastSeen: Date.now() });
            ref.onDisconnect().update({ online: false });
         }

         function attemptStart() {
             const name = document.getElementById("playerName").value.trim();
             if (name.length < 2) { alert(startRoasts[Math.floor(Math.random()*startRoasts.length)]); return; }
             currentPlayer = name;
             updateStatus();
             listenForInvites();
             document.getElementById("start-screen").style.display = "none";
             document.getElementById("toxic-ui").style.display = "flex";
             
             if (musicEnabled) document.getElementById("bgMusic").play();
             
             resetGame();
             gameRunning = true;
             gameLoop();
         }

         function resetGame() {
             snake = [{x: 400, y: 300}, {x: 380, y: 300}, {x: 360, y: 300}];
             dx = 20; dy = 0; nextDir = {dx:20, dy:0};
             totalScore = 0; toxicity = 0; isRage = false;
             createFood();
         }

         // --- SOCIAL SYSTEM (UPGRADED) ---
         function toggleSettings() {
             const mod = document.getElementById("settings-modal");
             mod.style.display = (mod.style.display === "block") ? "none" : "block";
             if(mod.style.display === "block") refreshSocial();
         }

         function refreshSocial() {
             if(!currentPlayer) return;
             db.ref(`requests/${currentPlayer.toLowerCase()}`).on('value', snap => {
                 const data = snap.val();
                 document.getElementById("req-box").innerHTML = data ? Object.keys(data).map(k => `
                     <div class="friend-row"><span>${k.toUpperCase()}</span><button onclick="acceptFriend('${k}')">ADD</button></div>
                 `).join('') : "No requests.";
             });
             db.ref(`friends/${currentPlayer.toLowerCase()}`).on('value', async snap => {
                 const friends = snap.val();
                 const list = document.getElementById("friends-list");
                 list.innerHTML = friends ? "" : "No friends yet.";
                 for(let f in friends) {
                     const uSnap = await db.ref(`users/${f}`).get();
                     const isOnline = uSnap.val()?.online;
                     list.innerHTML += `<div class="friend-row">
                         <span><span class="status-dot ${isOnline?'online':'offline'}"></span>${f.toUpperCase()}</span>
                         <div><button onclick="openChat('${f}')">CHAT</button>
                         ${isOnline?`<button onclick="inviteToDuel('${f}')">1v1</button>`:''}</div>
                     </div>`;
                 }
             });
         }

         async function acceptFriend(name) {
             await db.ref(`friends/${currentPlayer.toLowerCase()}/${name.toLowerCase()}`).set(true);
             await db.ref(`friends/${name.toLowerCase()}/${currentPlayer.toLowerCase()}`).set(true);
             await db.ref(`requests/${currentPlayer.toLowerCase()}/${name.toLowerCase()}`).remove();
         }

         function openChat(friend) {
             chatFriend = friend;
             document.getElementById("chat-header").innerText = "BEEF WITH: " + friend.toUpperCase();
             document.getElementById("chat-modal").style.display = "flex";
             const key = [currentPlayer.toLowerCase(), friend.toLowerCase()].sort().join("_");
             db.ref(`chats/${key}`).limitToLast(15).on('value', snap => {
                 const msgs = snap.val();
                 const container = document.getElementById("chat-display");
                 container.innerHTML = msgs ? Object.values(msgs).map(m => `
                     <div class="msg-line ${m.sender.toLowerCase()===currentPlayer.toLowerCase()?'msg-self':'msg-opp'}">
                         <b>${m.sender}:</b> ${m.text}
                     </div>`).join('') : "No messages.";
                 container.scrollTop = container.scrollHeight;
             });
         }

         function sendChatMessage() {
             const txt = document.getElementById("chatInput").value.trim();
             if(!txt || !chatFriend) return;
             const key = [currentPlayer.toLowerCase(), chatFriend.toLowerCase()].sort().join("_");
             db.ref(`chats/${key}`).push({ sender: currentPlayer, text: txt, time: Date.now() });
             document.getElementById("chatInput").value = "";
         }
         function closeChat() { document.getElementById("chat-modal").style.display = "none"; }

         // --- 1v1 LOGIC ---
         function listenForInvites() {
             db.ref(`duels_invite/${currentPlayer.toLowerCase()}`).on('value', snap => {
                 const d = snap.val();
                 if(d && d.status === "pending") {
                     lastOpponent = d.from; duelRoomId = d.room;
                     document.getElementById("inviter-name").innerText = d.from.toUpperCase() + " CHALLENGED YOU!";
                     document.getElementById("duel-invite-popup").style.display = "block";
                 }
             });
         }

         async function inviteToDuel(target) {
             lastOpponent = target;
             const rid = "room_" + Date.now();
             await db.ref(`duels_invite/${target.toLowerCase()}`).set({ from: currentPlayer, room: rid, status: "pending" });
             alert("Invite sent to " + target);
             db.ref(`duels_invite/${target.toLowerCase()}/status`).on('value', snap => {
                 if(snap.val() === "accepted") startDuel(rid, true, target);
             });
         }

         async function respondDuel(acc) {
             document.getElementById("duel-invite-popup").style.display = "none";
             if(acc) {
                 await db.ref(`duels_invite/${currentPlayer.toLowerCase()}`).update({status: "accepted"});
                 startDuel(duelRoomId, false, lastOpponent);
             } else { await db.ref(`duels_invite/${currentPlayer.toLowerCase()}`).remove(); }
         }

         function startDuel(rid, host, opp) {
             isDuel = true; duelRoomId = rid; isHost = host; lastOpponent = opp;
             gameRunning = true; isPaused = false;
             document.querySelectorAll('.overlay').forEach(el => el.style.display = 'none');
             
             snake = isHost ? [{x:600, y:300}, {x:620, y:300}] : [{x:100, y:300}, {x:80, y:300}];
             dx = isHost ? -20 : 20; dy = 0; totalScore = 0; p2Score = 0;

             if(isHost) {
                 createFood();
                 db.ref(`duel_rooms/${rid}`).set({ foodX, foodY, p1Body: snake, p2Body: [{x:100, y:300}, {x:80, y:300}], p1Score: 0, p2Score: 0, gameOver: false });
             }

             db.ref(`duel_rooms/${rid}`).on('value', snap => {
                 const v = snap.val(); if(!v) return;
                 foodX = v.foodX; foodY = v.foodY;
                 if(isHost) { snake2 = v.p2Body; p2Score = v.p2Score; } 
                 else { snake2 = v.p1Body; p2Score = v.p1Score; }
                 if(v.gameOver) handleDuelEnd(v.winner);
             });
             gameLoop();
         }

         // --- GAME ENGINE ---
         function gameLoop() {
             if (!gameRunning || isPaused) return;
             let speed = isDuel ? 80 : (isRage ? 45 : Math.max(55, 140 - (totalScore/4)));

             setTimeout(() => {
                 dx = nextDir.dx; dy = nextDir.dy;
                 let head = { x: snake[0].x + dx, y: snake[0].y + dy };

                 // Wrap logic
                 if(head.x < 0) head.x = 780; else if(head.x >= 800) head.x = 0;
                 if(head.y < 0) head.y = 580; else if(head.y >= 600) head.y = 0;

                 // Collisions
                 if(isDuel) {
                     if(snake.some(p=>p.x===head.x && p.y===head.y) || snake2.some(p=>p.x===head.x && p.y===head.y)) {
                         db.ref(`duel_rooms/${duelRoomId}`).update({ gameOver: true, winner: lastOpponent }); return;
                     }
                 } else if(snake.some(p=>p.x===head.x && p.y===head.y)) { handleGameOver(); return; }

                 snake.unshift(head);
                 if(head.x === foodX && head.y === foodY) {
                     totalScore += 10; playSound("eatSound");
                     if(!isDuel) { toxicity = Math.max(0, toxicity - 35); createFood(); }
                     else if(isHost) createFood();
                 } else { snake.pop(); }

                 if(!isDuel) {
                     toxicity = Math.min(100, toxicity + 0.2); // Toxicity slowly builds
                     isRage = toxicity >= 100;
                 } else {
                     const u = isHost ? { p1Body: snake, p1Score: totalScore } : { p2Body: snake, p2Score: totalScore };
                     db.ref(`duel_rooms/${duelRoomId}`).update(u);
                 }

                 draw();
                 gameLoop();
             }, speed);
         }

         function draw() {
             ctx.fillStyle = "#0f0524"; ctx.fillRect(0,0,800,600);
             // Food
             ctx.fillStyle = isRage ? "#ff0055" : "#00f2ff";
             ctx.beginPath(); ctx.arc(foodX+10, foodY+10, 8, 0, Math.PI*2); ctx.fill();
             // Snakes
             snake.forEach((p, i) => {
                 ctx.fillStyle = isRage ? "#ff0055" : (i===0 ? "#00f2ff" : "#7000ff");
                 ctx.fillRect(p.x, p.y, 18, 18);
             });
             if(isDuel) {
                 snake2.forEach((p, i) => {
                     ctx.fillStyle = (i===0 ? "#ff0055" : "#ff8800");
                     ctx.fillRect(p.x, p.y, 18, 18);
                 });
                 document.getElementById("score-display").innerHTML = `YOU: ${totalScore} | ${lastOpponent.toUpperCase()}: ${p2Score}`;
             }
             document.getElementById("scoreVal").innerText = totalScore;
             document.getElementById("toxic-bar").style.height = toxicity + "%";
         }

         // --- HELPERS ---
         function handleGameOver() {
             gameRunning = false; playSound("deathSound");
             db.ref(`scores/${currentPlayer.toLowerCase()}`).set({name: currentPlayer, score: totalScore});
             document.getElementById("over-roast").innerText = crashRoasts[Math.floor(Math.random()*crashRoasts.length)];
             document.getElementById("over-score").innerText = "SCORE: " + totalScore;
             document.getElementById("game-over-screen").style.display = "block";
         }

         function handleDuelEnd(w) {
             gameRunning = false;
             const won = w.toLowerCase() === currentPlayer.toLowerCase();
             document.getElementById("over-title").innerText = won ? "VICTORY" : "DEFEAT";
             document.getElementById("over-roast").innerText = won ? "Legendary stuff." : duelRoasts[Math.floor(Math.random()*duelRoasts.length)];
             document.getElementById("over-score").innerText = `Final Score: ${totalScore}`;
             document.getElementById("rematchBtn").style.display = "inline-block";
             document.getElementById("game-over-screen").style.display = "block";
             if(isHost) setTimeout(() => db.ref(`duel_rooms/${duelRoomId}`).remove(), 2000);
         }

         function createFood() {
             foodX = Math.floor(Math.random()*39)*20; foodY = Math.floor(Math.random()*29)*20;
             if(isDuel && isHost) db.ref(`duel_rooms/${duelRoomId}`).update({foodX, foodY});
         }

         // --- AUDIO & UI HELPERS ---
         function playSound(id) { if(sfxEnabled) { const s = document.getElementById(id); s.currentTime=0; s.play(); } }
         function toggleMusic() { 
            musicEnabled=!musicEnabled; 
            const b=document.getElementById("bgMusic"); 
            const btn = document.getElementById("musicBtn");
            musicEnabled?b.play():b.pause(); 
            musicEnabled?btn.classList.remove("muted"):btn.classList.add("muted");
         }
         function toggleSFX() { 
            sfxEnabled=!sfxEnabled; 
            const btn = document.getElementById("sfxBtn");
            sfxEnabled?btn.classList.remove("muted"):btn.classList.add("muted");
         }
         function togglePause() { if(!gameRunning || isDuel) return; isPaused=!isPaused; document.getElementById("pause-overlay").style.display=isPaused?"block":"none"; if(!isPaused) gameLoop(); }
         function fetchGlobalHigh() { db.ref("scores").orderByChild("score").limitToLast(1).on('value', snap => { const d = snap.val(); if(d) { const k = Object.keys(d)[0]; document.getElementById("highScoreVal").innerText = d[k].score; document.getElementById("highScoreName").innerText = d[k].name.toUpperCase(); } }); }
         function showLeaderboard() { 
             document.getElementById("leaderboard-screen").style.display="block"; 
             db.ref("scores").once('value', snap => { 
                 const d = snap.val(); 
                 if(d) { 
                     const s = Object.values(d).sort((a,b)=>b.score-a.score); 
                     document.getElementById("leaderboard-list").innerHTML = s.map((p,i)=>`<div class="lb-item" onclick="sendReq('${p.name}')"><span>${i+1}. ${p.name}</span><span>${p.score}</span></div>`).join(''); 
                 } 
             }); 
         }
         async function sendReq(t) { if(!currentPlayer || t.toLowerCase()===currentPlayer.toLowerCase()) return; await db.ref(`requests/${t.toLowerCase()}/${currentPlayer.toLowerCase()}`).set({time:Date.now()}); alert("Friend Request Sent!"); }
         function closeLeaderboard() { document.getElementById("leaderboard-screen").style.display="none"; }

         document.addEventListener("keydown", e => {
             const k = e.keyCode;
             if(k === 80) togglePause();
             if(isPaused) return;
             if((k===37||k===65) && dx===0) nextDir={dx:-20, dy:0};
             if((k===38||k===87) && dy===0) nextDir={dx:0, dy:-20};
             if((k===39||k===68) && dx===0) nextDir={dx:20, dy:0};
             if((k===40||k===83) && dy===0) nextDir={dx:0, dy:20};
         });
     </script>
</body>
</html>
