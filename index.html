<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Snake - Global Rage & 1v1</title>
    <style>
        body {
            background-color: #0d0221;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; color: #00f2ff;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden; user-select: none;
        }
        #start-screen, #pause-overlay, #leaderboard-screen, #game-over-screen, #friends-screen, #match-over-screen {
            position: absolute; background: rgba(15, 5, 36, 0.98);
            padding: 30px; border: 3px solid #00f2ff; text-align: center;
            z-index: 100; box-shadow: 0 0 50px #00f2ff;
        }
        .hidden { display: none !important; }
        
        /* UI Elements */
        .main-container { position: relative; display: flex; align-items: center; justify-content: center; }
        canvas { background-color: #0f0524; border: 4px solid #00f2ff; }
        input {
            background: #16213e; border: 2px solid #00f2ff; color: white;
            padding: 12px; margin: 10px auto; width: 220px;
            text-align: center; font-size: 18px; outline: none; display: block;
        }
        button {
            background: #ff0055; color: white; border: none;
            padding: 12px 25px; font-weight: bold; font-size: 16px;
            cursor: pointer; text-transform: uppercase; margin: 5px;
        }
        button:hover { filter: brightness(1.2); }
        .whatsapp-btn { background: #25D366; }
        .stats-bar {
            display: flex; justify-content: space-between;
            width: 800px; padding: 10px 20px; font-size: 18px;
            background: rgba(0, 242, 255, 0.1); margin-bottom: 10px;
        }

        /* 1v1 Specific UI */
        #invite-notification {
            position: fixed; top: 20px; left: 20px; background: #ff0055;
            padding: 15px; border: 2px solid white; z-index: 2000;
            box-shadow: 0 0 20px #ff0055; animation: blink 1s infinite;
        }
        @keyframes blink { 50% { opacity: 0.7; } }
        
        #chat-box {
            position: fixed; bottom: 20px; left: 20px; width: 250px;
            height: 300px; background: rgba(13, 2, 33, 0.9); border: 2px solid #00f2ff;
            display: flex; flex-direction: column; z-index: 500;
        }
        #chat-messages { flex-grow: 1; overflow-y: auto; padding: 5px; font-size: 12px; text-align: left; }
        
        .toxic-wrapper {
            position: absolute; right: -30px; display: none; flex-direction: column; align-items: center;
        }
        .toxic-container-vertical {
            width: 10px; height: 300px; background: #1a1a3a; border: 2px solid #00f2ff;
            border-radius: 10px; position: relative; overflow: hidden;
        }
        #toxic-bar { width: 100%; height: 0%; background: linear-gradient(0deg, #00f2ff, #ff0055); transition: height 0.3s; }

        .audio-settings { position: fixed; top: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 1000; }
        .circle-btn {
            width: 45px; height: 45px; border-radius: 50%; border: 2px solid #00f2ff;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
        }
        .circle-btn svg { width: 20px; fill: #00f2ff; }
        .muted { border-color: #ff0055; }
        .muted svg { fill: #ff0055; }
        
        #leaderboard-list, #friends-list { text-align: left; max-height: 300px; overflow-y: auto; margin: 15px 0; }
        .user-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #333; cursor: pointer; }
        .user-row:hover { background: rgba(0, 242, 255, 0.1); }
        .online-dot { width: 10px; height: 10px; background: #25D366; border-radius: 50%; display: inline-block; }
        .offline-dot { width: 10px; height: 10px; background: #555; border-radius: 50%; display: inline-block; }
    </style>
</head>
<body>

    <audio id="bgMusic" loop src="music.mp3"></audio>
    <audio id="eatSound" src="eat.mp3" preload="auto"></audio>
    <audio id="deathSound" src="death.mp3" preload="auto"></audio>

    <div class="audio-settings">
        <div id="musicBtn" class="circle-btn" onclick="toggleMusic()"><svg viewBox="0 0 24 24"><path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z"/></svg></div>
        <div id="sfxBtn" class="circle-btn" onclick="toggleSFX()"><svg viewBox="0 0 24 24"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg></div>
    </div>

    <div id="start-screen">
        <h1 style="font-size: 40px; margin:0;">THE SNAKE</h1>
        <input type="text" id="playerName" placeholder="Enter Name" maxlength="12">
        <button onclick="attemptStart()">SOLO RAGE ‚ö°</button>
        <button onclick="openFriends()">FRIENDS & 1v1 üë•</button>
        <button onclick="showLeaderboard()">HALL OF FAME üèÜ</button>
    </div>

    <div id="friends-screen" class="hidden">
        <h2>MY FRIENDS</h2>
        <div id="friends-list">Login to see friends...</div>
        <button onclick="document.getElementById('friends-screen').className='hidden'">BACK</button>
    </div>

    <div id="invite-notification" class="hidden">
        <p id="invite-text">Friend wants a 1v1!</p>
        <button onclick="acceptInvite()">ACCEPT</button>
        <button onclick="declineInvite()" style="background:#555">DECLINE</button>
    </div>

    <div id="leaderboard-screen" class="hidden">
        <h2>HALL OF FAME</h2>
        <p style="font-size: 10px;">Click a name to add friend</p>
        <div id="leaderboard-list"></div>
        <button onclick="document.getElementById('leaderboard-screen').className='hidden'">CLOSE</button>
    </div>

    <div id="game-over-screen" class="hidden">
        <h1 id="over-title">GAME OVER</h1>
        <p id="over-roast" style="color: #ff0055; font-weight: bold;"></p>
        <h2 id="over-score">SCORE: 0</h2>
        <button onclick="location.reload()">RETRY</button>
        <button class="whatsapp-btn" onclick="shareToWhatsApp()">SHARE üì≤</button>
    </div>

    <div id="match-over-screen" class="hidden">
        <h1 id="match-result">VICTORY!</h1>
        <p id="match-roast" style="color: #ff0055;"></p>
        <button onclick="rematchRequest()">REMATCH ‚öîÔ∏è</button>
        <button onclick="location.reload()">MENU</button>
        <button class="whatsapp-btn" onclick="share1v1()">SHARE RESULT</button>
    </div>

    <div id="chat-box" class="hidden">
        <div id="chat-messages"></div>
        <input type="text" id="chatInput" placeholder="Press Enter to send..." style="width:90%; font-size:12px;">
    </div>

    <div class="stats-bar">
        <div>SCORE: <span id="scoreVal">0</span></div>
        <div id="p2-score-ui" class="hidden" style="color: #7000ff;">P2 SCORE: <span id="p2ScoreVal">0</span></div>
        <div style="color: #ff0055;">WR: <span id="highScoreVal">0</span> BY <span id="highScoreName">NONE</span></div>
    </div>

    <div class="main-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="toxic-wrapper" id="toxic-ui">
            <div id="toxic-bar"></div>
        </div>
    </div>

    <script>
        // --- CONFIG & CONSTANTS ---
        const DB_URL = "https://snake-competition-default-rtdb.firebaseio.com/"; // Use your own Firebase URL
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");
        
        let currentPlayer = "";
        let playerId = "";
        let friends = JSON.parse(localStorage.getItem("snake_friends") || "[]");
        
        let gameRunning = false;
        let is1v1 = false;
        let isPaused = false;
        let musicEnabled = true;
        let sfxEnabled = true;

        // --- SNAKE STATE ---
        let snake = [{x: 400, y: 300}, {x: 380, y: 300}];
        let snake2 = []; // For 1v1
        let dx = 20, dy = 0, nextDir = {dx:20, dy:0};
        let foodX, foodY, totalScore = 0, p2Score = 0;
        let toxicity = 0, isRage = false;
        let chatTimer = 0, chatMsg = "";
        
        // --- MULTIPLAYER SYNC ---
        let currentRoom = null;
        let opponentId = null;

        const pvpRoasts = [
            "LMAO, you move like a brick!", "Is your internet powered by a hamster?", 
            "My grandma has better reflexes!", "Are you even trying?", "Imagine losing to me.",
            "You hit me? Blind much?", "Stay in your lane, kid."
        ];

        const winRoasts = ["GG EZ", "Sit down, trash.", "Go back to solo mode.", "Clown detected."];
        const loseRoasts = ["I lagged!", "Hacker!", "The snake is slippery today...", "Lucky hit."];

        const soloCrashRoasts = ["PATHETIC.", "THAT WALL HAD A FAMILY!", "SCORE LOWER THAN YOUR IQ.", "A POTATO HAS BETTER REFLEXES."];

        // --- INITIALIZATION ---
        async function attemptStart() {
            const name = document.getElementById("playerName").value.trim();
            if (name.length < 2) return alert("Enter a real name, you walnut!");
            currentPlayer = name;
            playerId = name.toLowerCase().replace(/\s/g, '');
            
            // Set Online Status
            updateStatus("online");
            listenForInvites();
            
            document.getElementById("start-screen").className = "hidden";
            document.getElementById("toxic-ui").style.display = "flex";
            
            startSolo();
        }

        function startSolo() {
            is1v1 = false;
            gameRunning = true;
            createFood();
            if (musicEnabled) document.getElementById("bgMusic").play();
            gameLoop();
        }

        function updateStatus(status) {
            fetch(`${DB_URL}users/${playerId}.json`, {
                method: 'PATCH',
                body: JSON.stringify({ name: currentPlayer, status: status, lastSeen: Date.now() })
            });
        }

        // --- FRIENDS & INVITES ---
        async function openFriends() {
            const name = document.getElementById("playerName").value.trim();
            if (name.length < 2) return alert("Enter name first!");
            currentPlayer = name;
            playerId = name.toLowerCase().replace(/\s/g, '');
            updateStatus("online");
            
            document.getElementById("friends-screen").className = "";
            renderFriends();
            listenForInvites();
        }

        async function renderFriends() {
            const list = document.getElementById("friends-list");
            list.innerHTML = "Syncing...";
            
            const resp = await fetch(`${DB_URL}users.json`);
            const users = await resp.json();
            
            let html = "";
            friends.forEach(fId => {
                const u = users[fId];
                if (u) {
                    const statusDot = u.status === "online" ? '<span class="online-dot"></span>' : '<span class="offline-dot"></span>';
                    html += `<div class="user-row" onclick="invitePlayer('${fId}')">
                        <span>${statusDot} ${u.name}</span>
                        <button style="font-size:10px">INVITE</button>
                    </div>`;
                }
            });
            list.innerHTML = html || "No friends added. Add people from Leaderboard!";
        }

        function invitePlayer(fId) {
            opponentId = fId;
            currentRoom = [playerId, fId].sort().join("_v_");
            fetch(`${DB_URL}invites/${fId}.json`, {
                method: 'PUT',
                body: JSON.stringify({ from: playerId, fromName: currentPlayer, room: currentRoom })
            });
            alert("Invite sent! Waiting...");
            waitForAcceptance();
        }

        function listenForInvites() {
            setInterval(async () => {
                const resp = await fetch(`${DB_URL}invites/${playerId}.json`);
                const inv = await resp.json();
                if (inv) {
                    document.getElementById("invite-text").innerText = `${inv.fromName} challenges you!`;
                    document.getElementById("invite-notification").className = "";
                    window.currentInvite = inv;
                }
            }, 3000);
        }

        async function acceptInvite() {
            const inv = window.currentInvite;
            currentRoom = inv.room;
            opponentId = inv.from;
            await fetch(`${DB_URL}rooms/${currentRoom}.json`, { method: 'PUT', body: JSON.stringify({ ready: true }) });
            await fetch(`${DB_URL}invites/${playerId}.json`, { method: 'DELETE' });
            document.getElementById("invite-notification").className = "hidden";
            start1v1();
        }

        async function waitForAcceptance() {
            const check = setInterval(async () => {
                const resp = await fetch(`${DB_URL}rooms/${currentRoom}.json`);
                const room = await resp.json();
                if (room && room.ready) {
                    clearInterval(check);
                    start1v1();
                }
            }, 2000);
        }

        // --- 1v1 GAMEPLAY ---
        function start1v1() {
            is1v1 = true;
            gameRunning = true;
            snake = [{x: 100, y: 300}, {x: 80, y: 300}];
            snake2 = [{x: 700, y: 300}, {x: 720, y: 300}];
            document.getElementById("p2-score-ui").className = "";
            document.getElementById("chat-box").className = "";
            document.getElementById("friends-screen").className = "hidden";
            document.getElementById("start-screen").className = "hidden";
            
            syncMultiplayer();
            gameLoop();
        }

        function syncMultiplayer() {
            // Send my data
            setInterval(() => {
                if (!gameRunning || !is1v1) return;
                fetch(`${DB_URL}rooms/${currentRoom}/${playerId}.json`, {
                    method: 'PUT',
                    body: JSON.stringify({ snake: snake, score: totalScore, chat: chatMsg })
                });
            }, 100);

            // Get opponent data
            setInterval(async () => {
                if (!gameRunning || !is1v1) return;
                const resp = await fetch(`${DB_URL}rooms/${currentRoom}/${opponentId}.json`);
                const data = await resp.json();
                if (data) {
                    snake2 = data.snake;
                    p2Score = data.score;
                    document.getElementById("p2ScoreVal").innerText = p2Score;
                }
            }, 100);
        }

        // --- CORE LOOP ---
        function gameLoop() {
            if (!gameRunning || isPaused) return;

            let speed = isRage ? 50 : 100;
            setTimeout(() => {
                ctx.fillStyle = "#0f0524"; ctx.fillRect(0,0,800,600);
                
                dx = nextDir.dx; dy = nextDir.dy;
                let head = {x: snake[0].x + dx, y: snake[0].y + dy};

                // Wrap around
                if (head.x < 0) head.x = 780; else if (head.x >= 800) head.x = 0;
                if (head.y < 0) head.y = 580; else if (head.y >= 600) head.y = 0;

                // Collisions
                if (checkBodyCollision(head, snake)) { endMatch("lose"); return; }
                
                if (is1v1) {
                    if (checkBodyCollision(head, snake2)) { endMatch("lose"); return; }
                }

                snake.unshift(head);

                if (head.x === foodX && head.y === foodY) {
                    totalScore += 10;
                    document.getElementById("scoreVal").innerText = totalScore;
                    if (sfxEnabled) document.getElementById("eatSound").play();
                    createFood();
                    toxicity = Math.max(0, toxicity - 20);
                } else {
                    snake.pop();
                }

                // Draw Snakes
                drawSnake(snake, isRage ? "#ff0055" : "#00f2ff");
                if (is1v1) drawSnake(snake2, "#7000ff");

                drawFood();
                
                if (chatTimer > 0) {
                    ctx.fillStyle = "white"; ctx.fillText(chatMsg, snake[0].x, snake[0].y - 10);
                    chatTimer--;
                }

                gameLoop();
            }, speed);
        }

        function drawSnake(s, color) {
            s.forEach((p, i) => {
                ctx.fillStyle = i === 0 ? "white" : color;
                ctx.fillRect(p.x, p.y, 18, 18);
            });
        }

        function drawFood() {
            ctx.fillStyle = "#ff0055";
            ctx.beginPath(); ctx.arc(foodX+10, foodY+10, 8, 0, Math.PI*2); ctx.fill();
        }

        function createFood() {
            foodX = Math.floor(Math.random() * 39) * 20;
            foodY = Math.floor(Math.random() * 29) * 20;
        }

        function checkBodyCollision(head, body) {
            return body.some(seg => seg.x === head.x && seg.y === head.y);
        }

        // --- END GAME ---
        function endMatch(status) {
            gameRunning = false;
            if (sfxEnabled) document.getElementById("deathSound").play();
            
            if (is1v1) {
                document.getElementById("match-over-screen").className = "";
                const result = totalScore > p2Score ? "VICTORY" : "DEFEAT";
                document.getElementById("match-result").innerText = result;
                document.getElementById("match-roast").innerText = result === "VICTORY" ? 
                    winRoasts[Math.floor(Math.random()*winRoasts.length)] : 
                    loseRoasts[Math.floor(Math.random()*loseRoasts.length)];
            } else {
                document.getElementById("game-over-screen").className = "";
                document.getElementById("over-roast").innerText = soloCrashRoasts[Math.floor(Math.random()*soloCrashRoasts.length)];
                document.getElementById("over-score").innerText = "SCORE: " + totalScore;
                saveScore(currentPlayer, totalScore);
            }
        }

        // --- HELPERS ---
        async function showLeaderboard() {
            const screen = document.getElementById("leaderboard-screen");
            screen.className = "";
            const list = document.getElementById("leaderboard-list");
            list.innerHTML = "Loading Legends...";
            
            const resp = await fetch(`${DB_URL}scores.json`);
            const data = await resp.json();
            if (data) {
                const sorted = Object.values(data).sort((a,b) => b.score - a.score);
                list.innerHTML = sorted.map(s => `
                    <div class="user-row" onclick="addFriend('${s.name.toLowerCase()}')">
                        <span>${s.name}</span>
                        <span>${s.score}</span>
                    </div>
                `).join('');
            }
        }

        function addFriend(fId) {
            if (fId === playerId) return;
            if (!friends.includes(fId)) {
                friends.push(fId);
                localStorage.setItem("snake_friends", JSON.stringify(friends));
                alert("Added as friend!");
            }
        }

        function toggleMusic() {
            musicEnabled = !musicEnabled;
            const m = document.getElementById("bgMusic");
            musicEnabled ? m.play() : m.pause();
            document.getElementById("musicBtn").classList.toggle("muted");
        }

        function toggleSFX() {
            sfxEnabled = !sfxEnabled;
            document.getElementById("sfxBtn").classList.toggle("muted");
        }

        document.addEventListener("keydown", e => {
            if (e.keyCode === 37 && dx === 0) nextDir = {dx:-20, dy:0};
            if (e.keyCode === 38 && dy === 0) nextDir = {dx:0, dy:-20};
            if (e.keyCode === 39 && dx === 0) nextDir = {dx:20, dy:0};
            if (e.keyCode === 40 && dy === 0) nextDir = {dx:0, dy:20};
            
            if (e.key === "Enter" && is1v1) {
                const inp = document.getElementById("chatInput");
                if (inp.value.trim()) {
                    chatMsg = inp.value;
                    chatTimer = 30;
                    const msgDiv = document.createElement("div");
                    msgDiv.innerText = `You: ${chatMsg}`;
                    document.getElementById("chat-messages").appendChild(msgDiv);
                    inp.value = "";
                }
            }
        });

        async function saveScore(name, score) {
            const pId = name.toLowerCase();
            await fetch(`${DB_URL}scores/${pId}.json`, {
                method: 'PUT',
                body: JSON.stringify({ name: name, score: score })
            });
        }

        function shareToWhatsApp() {
            const text = `üêç I scored ${totalScore} on The Snake! Challenge me: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }

        function share1v1() {
            const text = `üêç 1v1 Result: I got ${totalScore} and my friend got ${p2Score}! Beat us: ${window.location.href}`;
            window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
        }
        
        function rematchRequest() {
            alert("Invite sent for Rematch!");
            invitePlayer(opponentId);
            document.getElementById("match-over-screen").className = "hidden";
        }

        window.onbeforeunload = () => updateStatus("offline");
    </script>
</body>
</html>
