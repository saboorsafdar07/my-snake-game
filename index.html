<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Snake - Saboor's Global Rage & 1v1 Social</title>
    <style>
        body {
            background-color: #0d0221;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; color: #00f2ff;
            font-family: 'Courier New', Courier, monospace;
            overflow: hidden; user-select: none;
        }
        
        #start-screen, #pause-overlay, #leaderboard-screen, #game-over-screen, #settings-modal, #multiplayer-wait {
            position: absolute; background: rgba(15, 5, 36, 0.98);
            padding: 40px; border: 3px solid #00f2ff; text-align: center;
            box-shadow: 0 0 50px #00f2ff; display: none;
        }
        #start-screen { display: block; z-index: 10; }
        #leaderboard-screen { z-index: 100; width: 420px; max-height: 85vh; overflow-y: auto; }
        #settings-modal { z-index: 200; width: 400px; }
        #pause-overlay { z-index: 40; }
        #game-over-screen { z-index: 50; }
        #multiplayer-wait { z-index: 300; }

        .settings-toggle {
            position: fixed; top: 20px; right: 20px;
            width: 55px; height: 55px; border-radius: 50%;
            background: rgba(0, 242, 255, 0.1); border: 2px solid #00f2ff;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; z-index: 1000; transition: 0.3s;
        }
        .settings-toggle:hover { background: rgba(0, 242, 255, 0.3); transform: rotate(45deg); }
        .settings-toggle svg { width: 30px; fill: #00f2ff; }

        .modal-section { border-bottom: 1px solid rgba(0, 242, 255, 0.3); padding: 15px 0; }
        .friend-row { display: flex; justify-content: space-between; align-items: center; margin: 8px 0; font-size: 14px; background: rgba(255,255,255,0.05); padding: 5px; }

        .credits { position: absolute; bottom: 10px; right: 15px; font-size: 12px; color: #00f2ff; opacity: 0.7; }
        .main-container { position: relative; display: flex; align-items: center; justify-content: center; }
        .toxic-wrapper { position: absolute; right: -30px; display: none; flex-direction: column; align-items: center; }
        .toxic-label { font-size: 10px; font-weight: bold; color: #ff0055; writing-mode: vertical-rl; transform: rotate(180deg); margin-bottom: 5px;}
        .toxic-container-vertical { width: 10px; height: 300px; background: #1a1a3a; border: 2px solid #00f2ff; border-radius: 10px; display: flex; flex-direction: column; justify-content: flex-end; overflow: hidden; }
        #toxic-bar { width: 100%; height: 0%; background: linear-gradient(0deg, #00f2ff, #ff0055); transition: height 0.3s ease; }
        
        input { background: #16213e; border: 2px solid #00f2ff; color: white; padding: 12px; margin-bottom: 25px; width: 220px; text-align: center; font-size: 18px; outline: none; display: block; margin: 20px auto; }
        button { background: #ff0055; color: white; border: none; padding: 15px 35px; font-weight: bold; font-size: 18px; cursor: pointer; text-transform: uppercase; margin: 5px; transition: 0.2s; }
        button:hover { background: #00f2ff; color: #000; }
        .whatsapp-btn { background: #25D366; }
        .stats-bar { display: flex; justify-content: space-between; width: 800px; padding: 10px 20px; font-size: 18px; background: rgba(0, 242, 255, 0.1); margin-bottom: 10px; }
        
        canvas { background-color: #0f0524; border: 4px solid #00f2ff; }
        .lb-item { display: flex; justify-content: space-between; border-bottom: 1px solid #444; padding: 8px 0; cursor: pointer; }
        .lb-item:hover { background: rgba(0, 242, 255, 0.2); }
        .lb-header { color: #ff0055; font-weight: bold; margin: 15px 0 5px 0; border-bottom: 2px solid #ff0055; text-align: left; font-size: 14px; }
        .mvp-crown { color: gold; font-size: 18px; text-shadow: 0 0 10px gold; }
        
        .audio-circ { width: 50px; height: 50px; border-radius: 50%; border: 2px solid #00f2ff; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; margin: 0 10px; font-weight: bold; font-size: 12px;}
        .audio-circ.off { border-color: #ff0055; color: #ff0055; box-shadow: inset 0 0 10px #ff0055; }
    </style>
</head>
<body>

    <audio id="bgMusic" loop src="music.mp3"></audio>
    <audio id="eatSound" src="eat.mp3" preload="auto"></audio>
    <audio id="deathSound" src="death.mp3" preload="auto"></audio>

    <div class="settings-toggle" onclick="toggleSettings()">
        <svg viewBox="0 0 24 24"><path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.85,9.48l2.03,1.58C4.84,11.36,4.81,11.67,4.81,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.5c-1.93,0-3.5-1.57-3.5-3.5 s1.57-3.5,3.5-3.5s3.5,1.57,3.5,3.5S13.93,15.5,12,15.5z"/></svg>
    </div>

    <div id="settings-modal">
        <h2 style="color:#00f2ff; margin-top:0;">HUB SETTINGS</h2>
        <div class="modal-section">
            <div class="audio-circ" id="musicBtn" onclick="toggleMusic()">MUSIC</div>
            <div class="audio-circ" id="sfxBtn" onclick="toggleSFX()">SFX</div>
        </div>
        <div class="modal-section">
            <h3 style="font-size:14px; margin:0;">BEEF REQUESTS (1v1)</h3>
            <div id="req-box" style="margin-top:10px;">Checking for beef...</div>
        </div>
        <button onclick="toggleSettings()">BACK</button>
    </div>

    <div id="start-screen">
        <h1 style="font-size: 50px; margin:0; letter-spacing: 5px;">THE SNAKE</h1>
        <input type="text" id="playerName" placeholder="Your Name" maxlength="12">
        <button onclick="attemptStart()">QUICK START ‚ö°</button>
        <button onclick="showLeaderboard()">LEADERBOARD üèÜ</button>
        <div class="credits">Created by Saboor üç≠</div>
    </div>

    <div id="multiplayer-wait">
        <h2 id="wait-msg">WAITING FOR OPPONENT...</h2>
        <div class="audio-circ" style="width:100px; height:100px; font-size:24px;">‚åõ</div>
        <p>Don't close this screen.</p>
        <button onclick="location.reload()">CANCEL</button>
    </div>

    <div id="leaderboard-screen">
        <h2 style="color:#00f2ff; margin-top:0;">HALL OF FAME</h2>
        <p style="font-size: 11px; color: #ff0055; margin:0;">CLICK A NAME TO SEND BEEF (1v1)</p>
        <div id="leaderboard-list"></div>
        <button onclick="closeLeaderboard()" style="margin-top:20px;">CLOSE</button>
    </div>

    <div id="game-over-screen">
        <h1 id="over-title">WASTED</h1>
        <p id="over-roast" style="color: #ff0055; font-weight: bold; font-size: 18px;"></p>
        <h2 id="over-score">SCORE: 0</h2>
        <div id="multi-btns" style="display:none;">
            <button onclick="location.reload()">BACK TO MENU</button>
            <button id="rematchBtn" onclick="sendRematch()">REMATCH üî•</button>
        </div>
        <div id="solo-btns">
            <button onclick="location.reload()">RETRY</button>
        </div>
        <button class="whatsapp-btn" id="waBtn" onclick="shareToWhatsApp()">WHATSAPP SHARE üì≤</button>
    </div>

    <div id="pause-overlay"><h1>PAUSED</h1><button onclick="togglePause()">RESUME (P)</button></div>

    <div class="stats-bar">
        <div>SCORE: <span id="scoreVal">0</span> <span id="p2ScoreWrap" style="display:none;">| P2: <span id="p2ScoreVal">0</span></span></div>
        <div style="color: #ff0055;" id="wr-display">WR: <span id="highScoreVal">0</span> BY <span id="highScoreName">NONE</span></div>
    </div>

    <div class="main-container">
        <canvas id="gameCanvas" width="800" height="600"></canvas>
        <div class="toxic-wrapper" id="toxic-ui">
            <div class="toxic-label">TOXICITY</div>
            <div class="toxic-container-vertical"><div id="toxic-bar"></div></div>
        </div>
    </div>

    <script>
        const DB_URL = "https://snake-competition-default-rtdb.firebaseio.com/";
        const canvas = document.getElementById("gameCanvas");
        const ctx = canvas.getContext("2d");

        // --- ROAST LIBRARIES ---
        const startRoasts = ["Type a name, you uneducated walnut!", "Name box is empty, just like your future.", "Identify yourself so I know who to laugh at.", "Is your brain on airplane mode?", "Error 404: Player's identity not found."];
        const crashRoasts = ["PATHETIC. JUST UNINSTALL.", "THAT WALL HAD A FAMILY!", "SCORE LOWER THAN YOUR IQ.", "EVEN THE SNAKE IS DISAPPOINTED.", "A POTATO HAS BETTER REFLEXES."];
        const backhandedPraise = ["NEW RECORD! Finally the smartest among the idiots.", "HIGH SCORE! Mom is so proud.", "NEW RECORD! Luck is a powerful thing for the brainless."];
        const missRoasts = ["EMOTIONAL DAMAGE!", "WHEEZE... MISS?!", "NICE WHIFF!", "LMAO, TRASH.", "GIT GUD.", "STAY MAD.", "APPLE REJECTED YOU!"];
        
        // --- 1V1 SPECIAL ROASTS ---
        const v1Roasts = ["YOU MOVE LIKE A GLITCH!", "MY GRANDMA IS FASTER THAN YOU!", "ARE YOU EVEN TRYING?", "EAT MY DUST!", "MOVE ASIDE, NOOB.", "WATCH AND LEARN.", "IS THAT YOUR BEST?", "IMAGINE LOSING TO ME.", "SMELLS LIKE DEFEAT OVER THERE.", "REFLEXES OF A STATUE!"];

        let snake = [{x: 400, y: 300}, {x: 380, y: 300}, {x: 360, y: 300}];
        let snake2 = [{x: 100, y: 100}, {x: 80, y: 100}, {x: 60, y: 100}];
        let dx = 20, dy = 0, nextDir = {dx: 20, dy: 0};
        let dx2 = 20, dy2 = 0, nextDir2 = {dx: 20, dy: 0};
        
        let totalScore = 0, p2Score = 0;
        let foodX, foodY, toxicity = 0, isRage = false, gameRunning = false, isPaused = false;
        let chatTimer = 0, chatMsg = "", chatTimer2 = 0, chatMsg2 = "";
        let wasNear = false, missCombo = 0, currentPlayer = "";
        let globalBestScore = 0, globalBestName = "NONE", finalRoastMessage = "";
        let musicEnabled = true, sfxEnabled = true;

        // Multiplayer Vars
        let isMultiplayer = false;
        let isHost = false;
        let gameId = null;
        let opponentName = "";
        let multiPoll = null;

        // --- UI FIXES ---
        function toggleSettings() {
            const mod = document.getElementById("settings-modal");
            const start = document.getElementById("start-screen");
            const isOpen = mod.style.display === "block";
            mod.style.display = isOpen ? "none" : "block";
            if (!isOpen) { start.style.display = "none"; refreshSocialHub(); } 
            else if (!gameRunning) { start.style.display = "block"; }
        }

        function toggleMusic() {
            musicEnabled = !musicEnabled;
            const b = document.getElementById("bgMusic");
            musicEnabled ? b.play() : b.pause();
            document.getElementById("musicBtn").classList.toggle("off", !musicEnabled);
        }

        function toggleSFX() {
            sfxEnabled = !sfxEnabled;
            document.getElementById("sfxBtn").classList.toggle("off", !sfxEnabled);
        }

        // --- SOCIAL & MULTIPLAYER LOGIC ---
        async function refreshSocialHub() {
            if(!currentPlayer) { document.getElementById("req-box").innerHTML = "Enter name & start once to use Social Hub."; return; }
            try {
                const res = await fetch(`${DB_URL}requests/${currentPlayer.toLowerCase()}.json`);
                const data = await res.json();
                const box = document.getElementById("req-box");
                if(!data) box.innerHTML = "No pending beef.";
                else {
                    box.innerHTML = Object.keys(data).map(k => `<div class="friend-row"><span>${k.toUpperCase()}</span><button onclick="acceptBeef('${k}')" style="padding:5px 10px; font-size:10px;">JOIN</button></div>`).join('');
                }
            } catch(e) {}
        }

        async function sendFriendRequest(target) {
            if (!currentPlayer) {
                const nameInput = document.getElementById("playerName").value.trim();
                if (nameInput.length < 2) { alert("Enter your name first!"); return; }
                currentPlayer = nameInput;
            }
            if(target.toLowerCase() === currentPlayer.toLowerCase()) return;
            
            gameId = `game_${Date.now()}`;
            try {
                // Send Invite
                await fetch(`${DB_URL}requests/${target.toLowerCase()}/${currentPlayer.toLowerCase()}.json`, {
                    method: 'PUT', body: JSON.stringify({gameId: gameId, from: currentPlayer})
                });
                
                isHost = true;
                opponentName = target;
                document.getElementById("multiplayer-wait").style.display = "block";
                
                // Poll for acceptance
                multiPoll = setInterval(async () => {
                    const res = await fetch(`${DB_URL}matches/${gameId}.json`);
                    const data = await res.json();
                    if(data && data.accepted) {
                        clearInterval(multiPoll);
                        startMultiplayer();
                    }
                }, 2000);
                
            } catch(e) { alert("Server Fail."); }
        }

        async function acceptBeef(sender) {
            try {
                const res = await fetch(`${DB_URL}requests/${currentPlayer.toLowerCase()}/${sender.toLowerCase()}.json`);
                const invite = await res.json();
                gameId = invite.gameId;
                opponentName = sender;
                isHost = false;

                await fetch(`${DB_URL}matches/${gameId}.json`, {
                    method: 'PUT', body: JSON.stringify({accepted: true, foodX: 100, foodY: 100})
                });

                // Clear request
                await fetch(`${DB_URL}requests/${currentPlayer.toLowerCase()}/${sender.toLowerCase()}.json`, { method: 'DELETE' });
                
                startMultiplayer();
            } catch(e) { alert("Invite expired."); }
        }

        function startMultiplayer() {
            isMultiplayer = true;
            document.getElementById("multiplayer-wait").style.display = "none";
            document.getElementById("start-screen").style.display = "none";
            document.getElementById("p2ScoreWrap").style.display = "inline";
            document.getElementById("wr-display").style.display = "none";
            document.getElementById("settings-modal").style.display = "none";
            
            snake = [{x: 400, y: 300}, {x: 380, y: 300}, {x: 360, y: 300}];
            snake2 = [{x: 100, y: 100}, {x: 80, y: 100}, {x: 60, y: 100}];
            dx = 20; dy = 0; dx2 = 20; dy2 = 0;
            totalScore = 0; p2Score = 0;
            
            gameRunning = true;
            createFood();
            
            // Sync Loop
            multiPoll = setInterval(syncMultiplayer, 100);
            gameLoop();
        }

        async function syncMultiplayer() {
            const myPath = isHost ? "p1" : "p2";
            const opPath = isHost ? "p2" : "p1";
            
            // Send my data
            fetch(`${DB_URL}matches/${gameId}/${myPath}.json`, {
                method: 'PUT',
                body: JSON.stringify({snake: snake, score: totalScore, msg: chatMsg})
            });

            // Get opponent data
            const res = await fetch(`${DB_URL}matches/${gameId}/${opPath}.json`);
            const data = await res.json();
            if(data) {
                snake2 = data.snake;
                p2Score = data.score;
                chatMsg2 = data.msg;
                chatTimer2 = 20;
                document.getElementById("p2ScoreVal").innerText = p2Score;
            }
        }

        // --- CORE GAMEPLAY ---
        function attemptStart() {
            const name = document.getElementById("playerName").value.trim();
            if (name.length < 2) { alert(startRoasts[Math.floor(Math.random()*startRoasts.length)]); return; }
            currentPlayer = name;
            isMultiplayer = false;
            document.getElementById("start-screen").style.display = "none";
            document.getElementById("toxic-ui").style.display = "flex";
            gameRunning = true;
            createFood();
            if(musicEnabled) document.getElementById("bgMusic").play();
            gameLoop();
        }

        function createFood() {
            if(isMultiplayer && !isHost) return; 
            foodX = Math.floor(Math.random() * 39) * 20;
            foodY = Math.floor(Math.random() * 29) * 20;
            wasNear = false;
            if(isMultiplayer) {
                fetch(`${DB_URL}matches/${gameId}/food.json`, {method: 'PUT', body: JSON.stringify({x: foodX, y: foodY})});
            }
        }

        function gameLoop() {
            if (!gameRunning || isPaused) return;
            let speed = (isRage || isMultiplayer) ? 60 : Math.max(55, 150 - (totalScore/3));

            setTimeout(() => {
                if(isMultiplayer) {
                    // Fetch food from host
                    if(!isHost) {
                        fetch(`${DB_URL}matches/${gameId}/food.json`).then(r => r.json()).then(d => { if(d){foodX=d.x; foodY=d.y;}});
                    }
                }

                dx = nextDir.dx; dy = nextDir.dy;
                ctx.fillStyle = "#0f0524"; ctx.fillRect(0, 0, 800, 600);
                
                let nextX = snake[0].x + dx;
                let nextY = snake[0].y + dy;
                
                if(nextX < 0) nextX = 780; else if(nextX >= 800) nextX = 0;
                if(nextY < 0) nextY = 580; else if(nextY >= 600) nextY = 0;

                // Collisions
                const selfHit = snake.some(p => p.x === nextX && p.y === nextY);
                const p2Hit = isMultiplayer && snake2.some(p => p.x === nextX && p.y === nextY);

                if (selfHit || p2Hit) { handleGameOver(p2Hit ? "BODY SLAMMED!" : "CRASHED!"); return; }

                // Toxic Logic (Solo only)
                if(!isMultiplayer) {
                    let dist = Math.sqrt(Math.pow(nextX-foodX,2)+Math.pow(nextY-foodY,2));
                    if(dist < 35) wasNear = true;
                    else if(wasNear && dist > 45) {
                        toxicity = Math.min(100, toxicity + 20);
                        missCombo++;
                        if(missCombo >= 2) { chatMsg = missRoasts[Math.floor(Math.random()*missRoasts.length)]; chatTimer = 25; }
                        wasNear = false;
                    }
                }

                const head = {x: nextX, y: nextY};
                snake.unshift(head);

                if (head.x === foodX && head.y === foodY) {
                    totalScore += 10; toxicity = Math.max(0, toxicity - 40);
                    if(isMultiplayer && Math.random() > 0.5) { 
                        chatMsg = v1Roasts[Math.floor(Math.random()*v1Roasts.length)];
                        chatTimer = 30;
                    }
                    if(sfxEnabled) { document.getElementById("eatSound").currentTime=0; document.getElementById("eatSound").play(); }
                    createFood();
                } else { snake.pop(); }

                isRage = (toxicity >= 100);
                document.getElementById("toxic-bar").style.height = toxicity + "%";
                document.getElementById("scoreVal").innerText = totalScore;

                // Draw Food
                ctx.fillStyle = isRage ? "#ff0055" : "#00f2ff";
                ctx.beginPath(); ctx.arc(foodX+10, foodY+10, 8, 0, Math.PI*2); ctx.fill();

                // Draw P1
                snake.forEach((p, i) => {
                    ctx.fillStyle = isRage ? "#ff0055" : (i === 0 ? "#00f2ff" : "#7000ff");
                    ctx.fillRect(p.x, p.y, 18, 18);
                    if(i===0 && chatTimer > 0) {
                        ctx.fillStyle = "white"; ctx.font = "12px Arial";
                        ctx.fillText(chatMsg, p.x - 20, p.y - 15);
                        chatTimer--;
                    }
                });

                // Draw P2
                if(isMultiplayer) {
                    snake2.forEach((p, i) => {
                        ctx.fillStyle = (i === 0 ? "#25D366" : "#ffcc00");
                        ctx.fillRect(p.x, p.y, 18, 18);
                        if(i===0 && chatMsg2 && chatTimer2 > 0) {
                            ctx.fillStyle = "white"; ctx.font = "12px Arial";
                            ctx.fillText(chatMsg2, p.x - 20, p.y - 15);
                            chatTimer2--;
                        }
                    });
                }

                gameLoop();
            }, speed);
        }

        async function handleGameOver(reason) {
            gameRunning = false;
            clearInterval(multiPoll);
            document.getElementById("bgMusic").pause();
            if(sfxEnabled) document.getElementById("deathSound").play();
            
            if(isMultiplayer) {
                document.getElementById("multi-btns").style.display = "block";
                document.getElementById("solo-btns").style.display = "none";
                let win = totalScore > p2Score;
                if(reason === "BODY SLAMMED!") win = false;
                
                document.getElementById("over-title").innerText = win ? "VICTORY" : "DEFEATED";
                document.getElementById("over-roast").innerText = win ? `You crushed ${opponentName}!` : `${opponentName} made you look like a worm.`;
                document.getElementById("over-score").innerText = `${currentPlayer}: ${totalScore} vs ${opponentName}: ${p2Score}`;
                finalRoastMessage = win ? "I WON!" : "I LOST!";
            } else {
                const localHigh = parseInt(localStorage.getItem("snakeHighScore") || 0);
                if(totalScore > localHigh) {
                    finalRoastMessage = backhandedPraise[Math.floor(Math.random()*backhandedPraise.length)];
                    localStorage.setItem("snakeHighScore", totalScore);
                } else {
                    finalRoastMessage = crashRoasts[Math.floor(Math.random()*crashRoasts.length)];
                }
                document.getElementById("over-roast").innerText = finalRoastMessage;
                document.getElementById("over-score").innerText = "SCORE: " + totalScore;
                
                await fetch(`${DB_URL}scores/${currentPlayer.toLowerCase()}.json`, {
                    method: 'PUT', body: JSON.stringify({name: currentPlayer, score: totalScore})
                });
            }
            
            document.getElementById("game-over-screen").style.display = "block";
        }

        function sendRematch() {
            sendFriendRequest(opponentName);
            document.getElementById("game-over-screen").style.display = "none";
        }

        function shareToWhatsApp() {
            const link = window.location.href;
            let msg = "";
            if(isMultiplayer) {
                const win = totalScore > p2Score;
                msg = `üêç 1v1 SNAKE BATTLE RESULTS!\nüëë Winner: ${win?currentPlayer:opponentName}\nüíÄ Loser: ${win?opponentName:currentPlayer}\nScore: ${totalScore} - ${p2Score}\nPlay here: ${link}`;
            } else {
                msg = `üêç I scored ${totalScore} in The Snake!\nRoast: "${finalRoastMessage}"\nBeat me here: ${link}`;
            }
            window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`);
        }

        function togglePause() { 
            if(!gameRunning || isMultiplayer) return; // No pausing in 1v1
            isPaused = !isPaused; 
            document.getElementById("pause-overlay").style.display = isPaused ? "block" : "none";
            if(!isPaused) gameLoop();
        }

        async function fetchGlobalHigh() {
            try {
                const response = await fetch(DB_URL + "scores.json");
                const data = await response.json();
                if (data) {
                    const sorted = Object.values(data).sort((a,b) => b.score - a.score);
                    globalBestScore = sorted[0].score;
                    globalBestName = sorted[0].name;
                    document.getElementById("highScoreVal").innerText = globalBestScore;
                    document.getElementById("highScoreName").innerText = globalBestName.toUpperCase();
                }
            } catch(e) {}
        }

        async function showLeaderboard() {
            document.getElementById("leaderboard-screen").style.display = "block";
            const list = document.getElementById("leaderboard-list");
            list.innerHTML = "Syncing Records...";
            try {
                const response = await fetch(DB_URL + "scores.json");
                const data = await response.json();
                if (data) {
                    const sorted = Object.values(data).sort((a,b) => b.score - a.score);
                    let html = `<div class="lb-header">TOP 5 LEGENDS</div>`;
                    html += sorted.slice(0, 5).map((s, i) => `<div class="lb-item" onclick="sendFriendRequest('${s.name}')"><span>${i+1}. ${s.name} ${i===0?'<span class="mvp-crown">üëë MVP</span>':''}</span><span>${s.score}</span></div>`).join('');
                    html += `<div class="lb-header" style="margin-top:20px;">ALL CONTENDERS (Click to 1v1)</div>`;
                    html += sorted.map((s, i) => `<div class="lb-item" onclick="sendFriendRequest('${s.name}')"><span>${i+1}. ${s.name}</span><span>${s.score}</span></div>`).join('');
                    list.innerHTML = html;
                }
            } catch(e) { list.innerHTML = "Offline Mode."; }
        }

        function closeLeaderboard() { document.getElementById("leaderboard-screen").style.display = "none"; }

        document.addEventListener("keydown", e => {
            if(e.keyCode === 80) togglePause();
            if(isPaused) return;
            // P1 Controls
            if((e.keyCode === 37 || e.keyCode === 65) && dx === 0) nextDir = {dx: -20, dy: 0};
            if((e.keyCode === 38 || e.keyCode === 87) && dy === 0) nextDir = {dx: 0, dy: -20};
            if((e.keyCode === 39 || e.keyCode === 68) && dx === 0) nextDir = {dx: 20, dy: 0};
            if((e.keyCode === 40 || e.keyCode === 83) && dy === 0) nextDir = {dx: 0, dy: 20};
        });

        window.onload = fetchGlobalHigh;
    </script>
</body>
</html>
